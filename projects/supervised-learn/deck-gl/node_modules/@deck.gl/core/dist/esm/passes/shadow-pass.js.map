{"version":3,"sources":["../../../src/passes/shadow-pass.js"],"names":["default","LayersPass","Framebuffer","Texture2D","Renderbuffer","withParameters","ShadowPass","gl","props","shadowMap","width","height","parameters","depthBuffer","format","fbo","id","attachments","params","target","depthRange","depthTest","blend","clearColor","viewport","viewports","pixelRatio","resize","Object","assign","outputBuffer","layer","effects","effectProps","moduleParameters","create","context","pickingActive","drawToShadowMap","devicePixelRatio","delete"],"mappings":"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","sourcesContent":["import {default as LayersPass} from './layers-pass';\nimport {Framebuffer, Texture2D, Renderbuffer, withParameters} from '@luma.gl/core';\n\nexport default class ShadowPass extends LayersPass {\n  constructor(gl, props) {\n    super(gl, props);\n\n    // The shadowMap texture\n    this.shadowMap = new Texture2D(gl, {\n      width: 1,\n      height: 1,\n      parameters: {\n        [gl.TEXTURE_MIN_FILTER]: gl.LINEAR,\n        [gl.TEXTURE_MAG_FILTER]: gl.LINEAR,\n        [gl.TEXTURE_WRAP_S]: gl.CLAMP_TO_EDGE,\n        [gl.TEXTURE_WRAP_T]: gl.CLAMP_TO_EDGE\n      }\n    });\n\n    this.depthBuffer = new Renderbuffer(gl, {\n      format: gl.DEPTH_COMPONENT16,\n      width: 1,\n      height: 1\n    });\n\n    this.fbo = new Framebuffer(gl, {\n      id: 'shadowmap',\n      width: 1,\n      height: 1,\n      attachments: {\n        [gl.COLOR_ATTACHMENT0]: this.shadowMap,\n        // Depth attachment has to be specified for depth test to work\n        [gl.DEPTH_ATTACHMENT]: this.depthBuffer\n      }\n    });\n  }\n\n  render(params) {\n    const target = this.fbo;\n\n    withParameters(\n      this.gl,\n      {\n        depthRange: [0, 1],\n        depthTest: true,\n        blend: false,\n        clearColor: [1, 1, 1, 1]\n      },\n      () => {\n        const viewport = params.viewports[0];\n        const width = viewport.width * this.props.pixelRatio;\n        const height = viewport.height * this.props.pixelRatio;\n        if (width !== target.width || height !== target.height) {\n          target.resize({width, height});\n        }\n\n        super.render(Object.assign(params, {outputBuffer: target}));\n      }\n    );\n  }\n\n  getModuleParameters(layer, effects, effectProps) {\n    const moduleParameters = Object.assign(Object.create(layer.props), {\n      viewport: layer.context.viewport,\n      pickingActive: 0,\n      drawToShadowMap: true,\n      devicePixelRatio: this.props.pixelRatio\n    });\n\n    Object.assign(moduleParameters, effectProps);\n    return moduleParameters;\n  }\n\n  delete() {\n    if (this.fbo) {\n      this.fbo.delete();\n      this.fbo = null;\n    }\n\n    if (this.shadowMap) {\n      this.shadowMap.delete();\n      this.shadowMap = null;\n    }\n\n    if (this.depthBuffer) {\n      this.depthBuffer.delete();\n      this.depthBuffer = null;\n    }\n  }\n}\n"],"file":"shadow-pass.js"}