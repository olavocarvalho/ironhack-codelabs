!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t(require("deck"),require("luma"));else if("function"==typeof define&&define.amd)define(["deck","luma"],t);else{var n="object"==typeof exports?t(require("deck"),require("luma")):t(e.deck,e.luma);for(var i in n)("object"==typeof exports?exports:e)[i]=n[i]}}(window,function(e,t){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i:i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="",n(n.s=10)}([function(e,t){e.exports=function(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}},function(t,n){t.exports=e},function(e,n){e.exports=t},function(e,t){function n(t){return e.exports=n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},n(t)}e.exports=n},function(e,t){function n(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}e.exports=function(e,t,i){return t&&n(e.prototype,t),i&&n(e,i),e}},function(e,t){e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},function(e,t,n){var i=n(13),r=n(14);e.exports=function(e,t){return!t||"object"!==i(t)&&"function"!=typeof t?r(e):t}},function(e,t,n){var i=n(16);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&i(e,t)}},function(e,t,n){n(3);var i=n(15);function r(t,n,o){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=r=Reflect.get:e.exports=r=function(e,t,n){var r=i(e,t);if(r){var o=Object.getOwnPropertyDescriptor(r,t);return o.get?o.get.call(n):o.value}},r(t,n,o||t)}e.exports=r},function(e,t,n){var i=n(17),r=n(18),o=n(19);e.exports=function(e,t){return i(e)||r(e,t)||o()}},function(e,t,n){(function(t){const i=n(20),r=("undefined"==typeof window?t:window).deck||{};if(!r.LineLayer)throw new Error("@deck.gl/layers is not found");e.exports=Object.assign(r,i)}).call(this,n(12))},,function(e,t){var n;n=function(){return this}();try{n=n||new Function("return this")()}catch(e){"object"==typeof window&&(n=window)}e.exports=n},function(e,t){function n(e){return(n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function i(t){return"function"==typeof Symbol&&"symbol"===n(Symbol.iterator)?e.exports=i=function(e){return n(e)}:e.exports=i=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":n(e)},i(t)}e.exports=i},function(e,t){e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},function(e,t,n){var i=n(3);e.exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=i(e)););return e}},function(e,t){function n(t,i){return e.exports=n=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},n(t,i)}e.exports=n},function(e,t){e.exports=function(e){if(Array.isArray(e))return e}},function(e,t){e.exports=function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}},function(e,t){e.exports=function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}},function(e,t,n){"use strict";n.r(t);var i=n(5),r=n.n(i),o=n(4),a=n.n(o),s=n(6),l=n.n(s),u=n(3),c=n.n(u),g=n(8),h=n.n(g),d=n(7),f=n.n(d),v=n(1),p=[[255,255,178],[254,217,118],[254,178,76],[253,141,60],[240,59,32],[189,0,38]];function m(e){var t,n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Float32Array;if(Number.isFinite(e[0]))t=new i(e);else{t=new i(4*e.length);for(var r=0,o=0;o<e.length;o++){var a=e[o];t[r++]=a[0],t[r++]=a[1],t[r++]=a[2],t[r++]=Number.isFinite(a[3])?a[3]:255}}if(n)for(var s=0;s<t.length;s++)t[s]/=255;return t}var y=n(0),x=n.n(y),S=n(9),b=n.n(S),C=n(2);function M(e,t){return function(e){if(Array.isArray(e))return e}(e)||function(e,t){var n=[],i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done)&&(n.push(a.value),!t||n.length!==t);i=!0);}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return n}(e,t)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var w=1e-6,E="undefined"!=typeof Float32Array?Float32Array:Array;Math.random;Math.PI;function P(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3];return e[0]=n[0]*i+n[4]*r+n[8]*o+n[12]*a,e[1]=n[1]*i+n[5]*r+n[9]*o+n[13]*a,e[2]=n[2]*i+n[6]*r+n[10]*o+n[14]*a,e[3]=n[3]*i+n[7]*r+n[11]*o+n[15]*a,e}var k,A;k=new E(4),E!=Float32Array&&(k[0]=0,k[1]=0,k[2]=0,k[3]=0),A=k;function T(e,t){var n,i,r,o=P([],t,e);return n=o,i=o,r=1/o[3],n[0]=i[0]*r,n[1]=i[1]*r,n[2]=i[2]*r,n[3]=i[3]*r,o}function D(e,t,n){var i=t[0],r=t[1],o=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],g=t[8],h=t[9],d=t[10],f=t[11],v=t[12],p=t[13],m=t[14],y=t[15],x=n[0],S=n[1],b=n[2],C=n[3];return e[0]=x*i+S*s+b*g+C*v,e[1]=x*r+S*l+b*h+C*p,e[2]=x*o+S*u+b*d+C*m,e[3]=x*a+S*c+b*f+C*y,x=n[4],S=n[5],b=n[6],C=n[7],e[4]=x*i+S*s+b*g+C*v,e[5]=x*r+S*l+b*h+C*p,e[6]=x*o+S*u+b*d+C*m,e[7]=x*a+S*c+b*f+C*y,x=n[8],S=n[9],b=n[10],C=n[11],e[8]=x*i+S*s+b*g+C*v,e[9]=x*r+S*l+b*h+C*p,e[10]=x*o+S*u+b*d+C*m,e[11]=x*a+S*c+b*f+C*y,x=n[12],S=n[13],b=n[14],C=n[15],e[12]=x*i+S*s+b*g+C*v,e[13]=x*r+S*l+b*h+C*p,e[14]=x*o+S*u+b*d+C*m,e[15]=x*a+S*c+b*f+C*y,e}function _(e,t,n){var i,r,o,a,s,l,u,c,g,h,d,f,v=n[0],p=n[1],m=n[2];return t===e?(e[12]=t[0]*v+t[4]*p+t[8]*m+t[12],e[13]=t[1]*v+t[5]*p+t[9]*m+t[13],e[14]=t[2]*v+t[6]*p+t[10]*m+t[14],e[15]=t[3]*v+t[7]*p+t[11]*m+t[15]):(i=t[0],r=t[1],o=t[2],a=t[3],s=t[4],l=t[5],u=t[6],c=t[7],g=t[8],h=t[9],d=t[10],f=t[11],e[0]=i,e[1]=r,e[2]=o,e[3]=a,e[4]=s,e[5]=l,e[6]=u,e[7]=c,e[8]=g,e[9]=h,e[10]=d,e[11]=f,e[12]=i*v+s*p+g*m+t[12],e[13]=r*v+l*p+h*m+t[13],e[14]=o*v+u*p+d*m+t[14],e[15]=a*v+c*p+f*m+t[15]),e}function O(e,t,n){var i=n[0],r=n[1],o=n[2];return e[0]=t[0]*i,e[1]=t[1]*i,e[2]=t[2]*i,e[3]=t[3]*i,e[4]=t[4]*r,e[5]=t[5]*r,e[6]=t[6]*r,e[7]=t[7]*r,e[8]=t[8]*o,e[9]=t[9]*o,e[10]=t[10]*o,e[11]=t[11]*o,e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15],e}function N(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t[4],a=t[5],s=t[6],l=t[7],u=t[8],c=t[9],g=t[10],h=t[11];return t!==e&&(e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[4]=o*r+u*i,e[5]=a*r+c*i,e[6]=s*r+g*i,e[7]=l*r+h*i,e[8]=u*r-o*i,e[9]=c*r-a*i,e[10]=g*r-s*i,e[11]=h*r-l*i,e}function z(e,t,n){var i=Math.sin(n),r=Math.cos(n),o=t[0],a=t[1],s=t[2],l=t[3],u=t[4],c=t[5],g=t[6],h=t[7];return t!==e&&(e[8]=t[8],e[9]=t[9],e[10]=t[10],e[11]=t[11],e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]),e[0]=o*r+u*i,e[1]=a*r+c*i,e[2]=s*r+g*i,e[3]=l*r+h*i,e[4]=u*r-o*i,e[5]=c*r-a*i,e[6]=g*r-s*i,e[7]=h*r-l*i,e}function B(e,t,n,i,r){var o,a=1/Math.tan(t/2);return e[0]=a/n,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=a,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[11]=-1,e[12]=0,e[13]=0,e[15]=0,null!=r&&r!==1/0?(o=1/(i-r),e[10]=(r+i)*o,e[14]=2*r*i*o):(e[10]=-1,e[14]=-2*i),e}!function(){var e,t=(e=new E(2),E!=Float32Array&&(e[0]=0,e[1]=0),e)}();function F(e,t,n){var i=new E(3);return i[0]=e,i[1]=t,i[2]=n,i}function L(e,t){var n=t[0],i=t[1],r=t[2],o=n*n+i*i+r*r;return o>0&&(o=1/Math.sqrt(o)),e[0]=t[0]*o,e[1]=t[1]*o,e[2]=t[2]*o,e}!function(){var e,t=(e=new E(3),E!=Float32Array&&(e[0]=0,e[1]=0,e[2]=0),e)}();function j(e,t){if(!e)throw new Error(t||"viewport-mercator-project: assertion failed.")}Math.PI;function R(e,t){var n=M(e,3),i=n[0],r=n[1],o=n[2],a=void 0===o?0:o;return j(Number.isFinite(i)&&Number.isFinite(r)&&Number.isFinite(a)),T(t,[i,r,a,1])}var W,I={SUM:1,MEAN:2,MIN:3,MAX:4};function U(e,t){return e+t}function V(e,t){return t>e?t:e}function G(e,t){return t<e?t:e}function q(e,t){switch(I[e.toUpperCase()]||I.SUM){case I.MIN:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(G,1/0):null}(e,t)};case I.SUM:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(U,0):null}(e,t)};case I.MEAN:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(U,0)/n.length:null}(e,t)};case I.MAX:return function(e){return function(e,t){var n=e.map(t).filter(Number.isFinite);return n.length?n.reduce(V,-1/0):null}(e,t)};default:return null}}var Y,X={dataChanged:!0,viewportChanged:!0,cellSizeChanged:!0},H={changeFlags:X,projectPoints:!1,useGPU:!0,fp64:!1,viewport:null,gridTransformMatrix:null,createBufferObjects:!0},Z=[32775,32774],K=[32776,32774],Q=[32776,32775],J=(W={},x()(W,I.SUM,32774),x()(W,I.MEAN,32774),x()(W,I.MIN,Z),x()(W,I.MAX,K),W),$={size:1,operation:I.SUM,needMin:!1,needMax:!1,combineMaxMin:!1},ee=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1],te=(Y={},x()(Y,10240,9728),x()(Y,10241,9728),Y);function ne(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=t.width,i=void 0===n?1:n,r=t.height,o=void 0===r?1:r,a=t.data,s=void 0===a?null:a,l=t.unpackFlipY,u=void 0===l||l,c=t.parameters,g=void 0===c?te:c;return new C.Texture2D(e,{data:s,format:34836,type:5126,border:0,mipmaps:!1,parameters:g,dataFormat:6408,width:i,height:o,unpackFlipY:u})}function ie(e,t){var n=t.id,i=t.width,r=void 0===i?1:i,o=t.height,a=void 0===o?1:o,s=t.texture;return new C.Framebuffer(e,{id:n,width:r,height:a,attachments:x()({},36064,s)})}function re(e,t){var n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return!e||e.length<t?new Float32Array(t).fill(n):e}var oe=C.fp64.fp64ifyMatrix4,ae=["aggregationBuffer","maxMinBuffer","minBuffer","maxBuffer"],se={maxData:"maxBuffer",minData:"minBuffer",maxMinData:"maxMinBuffer"},le=function(){function e(t){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};r()(this,e),this.id=n.id||"gpu-grid-aggregator",this.shaderCache=n.shaderCache||null,this.gl=t,this.state={weights:null,gridPositions:null,positionsBuffer:null,positions64xyLowBuffer:null,vertexCount:0,fp64:null,useGPU:null,numCol:0,numRow:0,windowSize:null,cellSize:null,weightAttributes:{},textures:{},meanTextures:{},buffers:{},framebuffers:{},maxMinFramebuffers:{},minFramebuffers:{},maxFramebuffers:{},equations:{},resources:{},results:{}},this._hasGPUSupport=Object(C.isWebGL2)(t)&&Object(C.hasFeatures)(this.gl,C.FEATURES.BLEND_EQUATION_MINMAX,C.FEATURES.COLOR_ATTACHMENT_RGBA32F,C.FEATURES.TEXTURE_FLOAT)}return a()(e,null,[{key:"getAggregationData",value:function(e){var t=e.aggregationData,n=e.maxData,i=e.minData,r=e.maxMinData,o=4*e.pixelIndex,a={};return t&&(a.cellCount=t[o+3],a.cellWeight=t[o]),r?(a.maxCellWieght=r[0],a.minCellWeight=r[3]):(n&&(a.maxCellWieght=n[0],a.totalCount=n[3]),i&&(a.minCellWeight=i[0],a.totalCount=n[3])),a}},{key:"getCellData",value:function(e){for(var t=e.countsData,n=e.size,i=void 0===n?1:n,r=t.length/4,o=new Float32Array(r*i),a=new Uint32Array(r),s=0;s<r;s++){for(var l=0;l<i;l++)o[s*i+l]=t[4*s+l];a[s]=t[4*s+3]}return{cellCounts:a,cellWeights:o}}},{key:"isSupported",value:function(e){return Object(C.isWebGL2)(e)&&Object(C.hasFeatures)(e,C.FEATURES.BLEND_EQUATION_MINMAX,C.FEATURES.COLOR_ATTACHMENT_RGBA32F,C.FEATURES.TEXTURE_FLOAT)}}]),a()(e,[{key:"delete",value:function(){var e=this.gridAggregationModel,t=this.allAggregationModel,n=this.meanTransform,i=this.state,r=i.positionsBuffer,o=i.positions64xyLowBuffer,a=i.textures,s=i.framebuffers,l=i.maxMinFramebuffers,u=i.minFramebuffers,c=i.maxFramebuffers,g=i.meanTextures,h=i.resources;e&&e.delete(),t&&t.delete(),n&&n.delete(),r&&r.delete(),o&&o.delete(),this.deleteResources([s,a,l,u,c,g,h])}},{key:"run",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.setState({results:{}});var t=this.getAggregationParams(e);this.updateGridSize(t);var n=t.useGPU;return this._hasGPUSupport&&n?this.runAggregationOnGPU(t):(n&&v.log.warn("GPUGridAggregator: GPU Aggregation not supported, falling back to CPU")(),this.runAggregationOnCPU(t))}},{key:"getData",value:function(e){var t={},n=this.state.results;for(var i in n[e].aggregationData||(n[e].aggregationData=n[e].aggregationBuffer.getData()),t.aggregationData=n[e].aggregationData,se){var r=se[i];(n[e][i]||n[e][r])&&(n[e][i]=n[e][i]||n[e][r].getData(),t[i]=n[e][i])}return t}},{key:"deleteResources",value:function(e){(e=Array.isArray(e)?e:[e]).forEach(function(e){for(var t in e)e[t].delete()})}},{key:"getAggregationParams",value:function(e){var t=Object.assign({},H,e),n=t.useGPU,i=t.gridTransformMatrix,r=t.viewport,o=t.weights,a=t.projectPoints,s=t.cellSize;return this.state.useGPU!==n&&(t.changeFlags=Object.assign({},t.changeFlags,X)),!s||this.state.cellSize&&this.state.cellSize[0]===s[0]&&this.state.cellSize[1]===s[1]||(t.changeFlags.cellSizeChanged=!0,this.setState({cellSize:s})),this.validateProps(t,e),this.setState({useGPU:n}),t.gridTransformMatrix=(a?r.viewportMatrix:i)||ee,o&&(t.weights=this.normalizeWeightParams(o),this.setState({weights:t.weights})),t}},{key:"normalizeWeightParams",value:function(e){var t={};for(var n in e)t[n]=Object.assign({},$,e[n]);return t}},{key:"setState",value:function(e){Object.assign(this.state,e)}},{key:"shouldTransformToGrid",value:function(e){var t=e.projectPoints,n=e.changeFlags;return!!(!this.state.gridPositions||n.dataChanged||t&&n.viewportChanged)}},{key:"updateGridSize",value:function(e){var t=e.viewport,n=e.cellSize,i=e.width||t.width,r=e.height||t.height,o=Math.ceil(i/n[0]),a=Math.ceil(r/n[1]);this.setState({numCol:o,numRow:a,windowSize:[i,r]})}},{key:"validateProps",value:function(e,t){var n=e.changeFlags,i=e.projectPoints,r=e.gridTransformMatrix;v.log.assert(n.dataChanged||n.viewportChanged||n.cellSizeChanged),v.log.assert(!n.dataChanged||t.positions&&t.weights&&(!t.projectPositions||t.viewport)&&t.cellSize),v.log.assert(!n.cellSizeChanged||t.cellSize),v.log.assert(!(n.viewportChanged&&i)||t.viewport),i&&r&&v.log.warn("projectPoints is true, gridTransformMatrix is ignored")()}},{key:"calculateAggregationData",value:function(e){var t=e.weights,n=e.results,i=e.cellIndex,r=e.posIndex;for(var o in t){for(var a=t[o],s=a.values,l=a.size,u=a.operation,c=n[o].aggregationData,g=0;g<l;g++){var h=i+g,d=s[3*r+g];if(0===c[i+3])c[h]=d;else switch(u){case I.SUM:case I.MEAN:c[h]+=d;break;case I.MIN:c[h]=Math.min(c[h],d);break;case I.MAX:c[h]=Math.max(c[h],d);break;default:v.log.assert(!1)}}c[i+3]++}}},{key:"calculateMeanMaxMinData",value:function(e){var t=e.validCellIndices,n=e.results,i=e.weights;t.forEach(function(e){for(var t in n){for(var r=i[t],o=r.size,a=r.needMin,s=r.needMax,l=r.operation,u=n[t],c=u.aggregationData,g=u.minData,h=u.maxData,d=u.maxMinData,f=a||s,v=l===I.MEAN,p=a&&s&&i[t].combineMaxMin,m=c[e+4-1],y=0;y<o&&(f||v);y++){var x=e+y,S=c[x];v&&(c[x]/=m,S=c[x]),p?d[y]=Math.max(d[y],S):(a&&(g[y]=Math.min(g[y],S)),s&&(h[y]=Math.max(h[y],S)))}p?d[3]=Math.min(d[3],c[e+0]):(a&&(g[3]+=m),s&&(h[3]+=m))}})}},{key:"initCPUResults",value:function(e){var t=e.weights||this.state.weights,n=this.state,i=n.numCol,r=n.numRow,o={};for(var a in t){var s=t[a],l=s.aggregationData,u=s.minData,c=s.maxData,g=s.maxMinData,h=t[a],d=h.needMin,f=h.needMax,v=d&&f&&t[a].combineMaxMin;l=re(l,i*r*4),v?((g=re(g,4)).fill(-1/0,0,3),g[3]=1/0):(d&&((u=re(u,4,1/0))[3]=0),f&&((c=re(c,4,-1/0))[3]=0)),o[a]=Object.assign({},t[a],{aggregationData:l,minData:u,maxData:c,maxMinData:g})}return o}},{key:"runAggregationOnCPU",value:function(e){var t,n,i=e.positions,r=e.cellSize,o=e.gridTransformMatrix,a=e.viewport,s=e.projectPoints,l=e.weights,u=this.state,c=u.numCol,g=u.numRow,h=this.initCPUResults(e),d=this.shouldTransformToGrid(e),f=[0,0,0];v.log.assert(d||e.changeFlags.cellSizeChanged),d?(n=i.length/2,t=new Float64Array(i.length),this.setState({gridPositions:t})):(t=this.state.gridPositions,l=this.state.weights,n=t.length/2);for(var p=new Set,m=0;m<n;m++){var y=void 0,x=void 0;if(d){if(f[0]=i[2*m],f[1]=i[2*m+1],s){var S=a.project(f),C=b()(S,2);y=C[0],x=C[1]}else{var M=R(f,o),w=b()(M,2);y=w[0],x=w[1]}t[2*m]=y,t[2*m+1]=x}else y=t[2*m],x=t[2*m+1];var E=Math.floor(y/r[0]),P=Math.floor(x/r[1]);if(E>=0&&E<c&&P>=0&&P<g){var k=4*(E+P*c);p.add(k),this.calculateAggregationData({weights:l,results:h,cellIndex:k,posIndex:m})}}return this.calculateMeanMaxMinData({validCellIndices:p,results:h,weights:l}),this.updateAggregationBuffers(e,h),this.setState({results:h}),h}},{key:"updateCPUResultBuffer",value:function(e){var t=e.gl,n=e.bufferName,i=e.id,r=e.data,o=e.result,a=this.state.resources,s="cpu-result-".concat(i,"-").concat(n);o[n]=o[n]||a[s],o[n]?o[n].setData({data:r}):(a[s]=new C.Buffer(t,r),o[n]=a[s])}},{key:"updateAggregationBuffers",value:function(e,t){if(e.createBufferObjects){var n=e.weights||this.state.weights;for(var i in t){var r=t[i],o=r.aggregationData,a=r.minData,s=r.maxData,l=r.maxMinData,u=n[i],c=u.needMin,g=u.needMax,h=c&&g&&n[i].combineMaxMin;this.updateCPUResultBuffer({gl:this.gl,bufferName:"aggregationBuffer",id:i,data:o,result:t[i]}),h?this.updateCPUResultBuffer({gl:this.gl,bufferName:"maxMinBuffer",id:i,data:l,result:t[i]}):(c&&this.updateCPUResultBuffer({gl:this.gl,bufferName:"minBuffer",id:i,data:a,result:t[i]}),g&&this.updateCPUResultBuffer({gl:this.gl,bufferName:"maxBuffer",id:i,data:s,result:t[i]}))}}}},{key:"getAggregateData",value:function(e){var t={},n=this.state,i=n.textures,r=n.framebuffers,o=n.maxMinFramebuffers,a=n.minFramebuffers,s=n.maxFramebuffers,l=n.weights;for(var u in l){t[u]={};var c=l[u],g=c.needMin,h=c.needMax,d=c.combineMaxMin;t[u].aggregationTexture=i[u],t[u].aggregationBuffer=Object(C.readPixelsToBuffer)(r[u],{target:l[u].aggregationBuffer,sourceType:5126}),g&&h&&d?t[u].maxMinBuffer=Object(C.readPixelsToBuffer)(o[u],{target:l[u].maxMinBuffer,sourceType:5126}):(g&&(t[u].minBuffer=Object(C.readPixelsToBuffer)(a[u],{target:l[u].minBuffer,sourceType:5126})),h&&(t[u].maxBuffer=Object(C.readPixelsToBuffer)(s[u],{target:l[u].maxBuffer,sourceType:5126})))}return this.trackGPUResultBuffers(t,l),t}},{key:"getAggregationModel",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.gl,n=this.shaderCache;return new C.Model(t,{id:"Gird-Aggregation-Model",vs:e?"#define SHADER_NAME gpu-aggregation-to-grid-vs-64\n\nattribute vec2 positions;\nattribute vec2 positions64xyLow;\nattribute vec3 weights;\nuniform vec2 windowSize;\nuniform vec2 cellSize;\nuniform vec2 gridSize;\nuniform vec2 uProjectionMatrixFP64[16];\nuniform bool projectPoints;\n\nvarying vec3 vWeights;\n\nvoid project_to_pixel(vec2 pos, vec2 pos64xyLow, out vec2 pixelXY64[2]) {\n\n  vec2 result64[4];\n  vec2 position64[4];\n  position64[0] = vec2(pos.x, pos64xyLow.x);\n  position64[1] = vec2(pos.y, pos64xyLow.y);\n  position64[2] = vec2(0., 0.);\n  position64[3] = vec2(1., 0.);\n  mat4_vec4_mul_fp64(uProjectionMatrixFP64, position64,\n  result64);\n\n  pixelXY64[0] = div_fp64(result64[0], result64[3]);\n  pixelXY64[1] = div_fp64(result64[1], result64[3]);\n}\n\nvoid main(void) {\n\n  vWeights = weights;\n\n  vec2 windowPos = positions;\n  vec2 windowPos64xyLow = positions64xyLow;\n  if (projectPoints) {\n    vec2 projectedXY[2];\n    project_position_fp64(windowPos, windowPos64xyLow, projectedXY);\n    windowPos.x = projectedXY[0].x;\n    windowPos.y = projectedXY[1].x;\n    windowPos64xyLow.x = projectedXY[0].y;\n    windowPos64xyLow.y = projectedXY[1].y;\n  }\n\n  vec2 pixelXY64[2];\n  project_to_pixel(windowPos, windowPos64xyLow, pixelXY64);\n  vec2 gridXY64[2];\n  gridXY64[0] = div_fp64(pixelXY64[0], vec2(cellSize.x, 0));\n  gridXY64[1] = div_fp64(pixelXY64[1], vec2(cellSize.y, 0));\n  float x = floor(gridXY64[0].x);\n  float y = floor(gridXY64[1].x);\n  vec2 pos = vec2(x, y);\n  pos = (pos * (2., 2.) / (gridSize)) - (1., 1.);\n  vec2 offset = 1.0 / gridSize;\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n}\n":"#define SHADER_NAME gpu-aggregation-to-grid-vs\n\nattribute vec2 positions;\nattribute vec3 weights;\nuniform vec2 windowSize;\nuniform vec2 cellSize;\nuniform vec2 gridSize;\nuniform mat4 uProjectionMatrix;\nuniform bool projectPoints;\n\nvarying vec3 vWeights;\n\nvec2 project_to_pixel(vec4 pos) {\n  vec4 result =  uProjectionMatrix * pos;\n  return result.xy/result.w;\n}\n\nvoid main(void) {\n\n  vWeights = weights;\n\n  vec4 windowPos = vec4(positions, 0, 1.);\n  if (projectPoints) {\n    windowPos = project_position_to_clipspace(vec3(positions, 0), vec2(0, 0), vec3(0, 0, 0));\n  }\n\n  vec2 pos = project_to_pixel(windowPos);\n  pos = floor(pos / cellSize);\n  pos = (pos * (2., 2.) / (gridSize)) - (1., 1.);\n  vec2 offset = 1.0 / gridSize;\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n}\n",fs:"#define SHADER_NAME gpu-aggregation-to-grid-fs\n\nprecision highp float;\n\nvarying vec3 vWeights;\n\nvoid main(void) {\n  gl_FragColor = vec4(vWeights, 1.0);\n}\n",modules:e?[v.project64]:["project32"],shaderCache:n,vertexCount:0,drawMode:0})}},{key:"getAllAggregationModel",value:function(){var e=this.gl,t=this.shaderCache,n=this.state,i=n.numCol,r=n.numRow;return new C.Model(e,{id:"All-Aggregation-Model",vs:"#version 300 es\n#define SHADER_NAME gpu-aggregation-all-vs-64\n\nin vec2 position;\nuniform ivec2 gridSize;\nout vec2 vTextureCoord;\n\nvoid main(void) {\n  vec2 pos = vec2(-1.0, -1.0);\n  vec2 offset = 1.0 / vec2(gridSize);\n  pos = pos + offset;\n\n  gl_Position = vec4(pos, 0.0, 1.0);\n\n  int yIndex = gl_InstanceID / gridSize[0];\n  int xIndex = gl_InstanceID - (yIndex * gridSize[0]);\n\n  vec2 yIndexFP64 = vec2(float(yIndex), 0.);\n  vec2 xIndexFP64 = vec2(float(xIndex), 0.);\n  vec2 gridSizeYFP64 = vec2(gridSize[1], 0.);\n  vec2 gridSizeXFP64 = vec2(gridSize[0], 0.);\n\n  vec2 texCoordXFP64 = div_fp64(yIndexFP64, gridSizeYFP64);\n  vec2 texCoordYFP64 = div_fp64(xIndexFP64, gridSizeXFP64);\n\n  vTextureCoord = vec2(texCoordYFP64.x, texCoordXFP64.x);\n}\n",fs:"#version 300 es\n#define SHADER_NAME gpu-aggregation-all-fs\n\nprecision highp float;\n\nin vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform bool combineMaxMin;\nout vec4 fragColor;\nvoid main(void) {\n  vec4 textureColor = texture(uSampler, vec2(vTextureCoord.s, vTextureCoord.t));\n  if (textureColor.a == 0.) {\n    discard;\n  }\n  fragColor.rgb = textureColor.rgb;\n  fragColor.a = combineMaxMin ? textureColor.r : textureColor.a;\n}\n",modules:[C.fp64],shaderCache:t,vertexCount:1,drawMode:0,isInstanced:!0,instanceCount:i*r,attributes:{position:[0,0]}})}},{key:"getMeanTransform",value:function(e){return this.meanTransform?this.meanTransform.update(e):this.meanTransform=new C.Transform(this.gl,Object.assign({},{vs:"#define SHADER_NAME gpu-aggregation-transform-mean-vs\nattribute vec4 aggregationValues;\nvarying vec4 meanValues;\n\nvoid main()\n{\n  bool isCellValid = bool(aggregationValues.w > 0.);\n  meanValues.xyz = isCellValid ? aggregationValues.xyz/aggregationValues.w : vec3(0, 0, 0);\n  meanValues.w = aggregationValues.w;\n}\n",_targetTextureVarying:"meanValues"},e)),this.meanTransform}},{key:"renderAggregateData",value:function(e){var t=e.cellSize,n=e.viewport,i=e.gridTransformMatrix,r=e.projectPoints,o=this.state,a=o.numCol,s=o.numRow,l=o.windowSize,u=o.maxMinFramebuffers,c=o.minFramebuffers,g=o.maxFramebuffers,h=o.weights,d=[a,s],f={blend:!0,depthTest:!1,blendFunc:[1,1]},v={viewport:n},p={windowSize:l,cellSize:t,gridSize:d,uProjectionMatrix:i,uProjectionMatrixFP64:oe(i),projectPoints:r};for(var m in h){var y=h[m],x=y.needMin,S=y.needMax,b=x&&S&&h[m].combineMaxMin;this.renderToWeightsTexture({id:m,parameters:f,moduleSettings:v,uniforms:p,gridSize:d}),b?this.renderToMaxMinTexture({id:m,parameters:Object.assign({},f,{blendEquation:Q}),gridSize:d,minOrMaxFb:u[m],clearParams:{clearColor:[0,0,0,3.402823466e38]},combineMaxMin:b}):(x&&this.renderToMaxMinTexture({id:m,parameters:Object.assign({},f,{blendEquation:Z}),gridSize:d,minOrMaxFb:c[m],clearParams:{clearColor:[3.402823466e38,3.402823466e38,3.402823466e38,0]},combineMaxMin:b}),S&&this.renderToMaxMinTexture({id:m,parameters:Object.assign({},f,{blendEquation:K}),gridSize:d,minOrMaxFb:g[m],combineMaxMin:b}))}}},{key:"renderToMaxMinTexture",value:function(e){var t=e.id,n=e.parameters,i=e.gridSize,r=e.minOrMaxFb,o=e.combineMaxMin,a=e.clearParams,s=void 0===a?{}:a,l=this.state.framebuffers,u=this.gl,c=this.allAggregationModel;r.bind(),u.viewport(0,0,i[0],i[1]),Object(C.withParameters)(u,s,function(){u.clear(16384)}),c.draw({parameters:n,uniforms:{uSampler:l[t].texture,gridSize:i,combineMaxMin:o}}),r.unbind()}},{key:"renderToWeightsTexture",value:function(e){var t=e.id,n=e.parameters,i=e.moduleSettings,r=e.uniforms,o=e.gridSize,a=this.state,s=a.framebuffers,l=a.equations,u=a.weightAttributes,c=a.weights,g=this.gl,h=this.gridAggregationModel,d=c[t].operation;s[t].bind(),g.viewport(0,0,o[0],o[1]);var f=d===I.MIN?[3.402823466e38,3.402823466e38,3.402823466e38,0]:[0,0,0,0];Object(C.withParameters)(g,{clearColor:f},function(){g.clear(16384)});var v={weights:u[t]};if(h.draw({parameters:Object.assign({},n,{blendEquation:l[t]}),moduleSettings:i,uniforms:r,attributes:v}),s[t].unbind(),d===I.MEAN){var p=this.state,m=p.meanTextures,y=p.textures,S={_sourceTextures:{aggregationValues:m[t]},_targetTexture:y[t],elementCount:y[t].width*y[t].height};this.getMeanTransform(S).run({parameters:{blend:!1,depthTest:!1}}),s[t].attach(x()({},36064,y[t]))}}},{key:"runAggregationOnGPU",value:function(e){this.updateModels(e),this.setupFramebuffers(e),this.renderAggregateData(e);var t=this.getAggregateData(e);return this.setState({results:t}),t}},{key:"setupFramebuffers",value:function(e){var t=this.state,n=t.numCol,i=t.numRow,r=t.textures,o=t.framebuffers,a=t.maxMinFramebuffers,s=t.minFramebuffers,l=t.maxFramebuffers,u=t.resources,c=t.meanTextures,g=t.equations,h=t.weights,d={width:n,height:i};for(var f in h){var v=h[f],p=v.needMin,m=v.needMax,y=v.combineMaxMin,S=v.operation;r[f]=h[f].aggregationTexture||r[f]||ne(this.gl,{id:"".concat(f,"-texture"),width:n,height:i}),r[f].resize(d);var b=r[f];S===I.MEAN&&(c[f]=c[f]||ne(this.gl,{id:"".concat(f,"-mean-texture"),width:n,height:i}),c[f].resize(d),b=c[f]),o[f]?o[f].attach(x()({},36064,b)):o[f]=ie(this.gl,{id:"".concat(f,"-fb"),width:n,height:i,texture:b}),o[f].resize(d),g[f]=J[S],(p||m)&&(p&&m&&y?a[f]||(u["".concat(f,"-maxMin")]=ne(this.gl,{id:"".concat(f,"-maxMinTex")}),a[f]=ie(this.gl,{id:"".concat(f,"-maxMinFb"),texture:u["".concat(f,"-maxMin")]})):(p&&(s[f]||(u["".concat(f,"-min")]=ne(this.gl,{id:"".concat(f,"-minTex")}),s[f]=ie(this.gl,{id:"".concat(f,"-minFb"),texture:u["".concat(f,"-min")]}))),m&&(l[f]||(u["".concat(f,"-max")]=ne(this.gl,{id:"".concat(f,"-maxTex")}),l[f]=ie(this.gl,{id:"".concat(f,"-maxFb"),texture:u["".concat(f,"-max")]})))))}}},{key:"setupModels",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.gridAggregationModel&&this.gridAggregationModel.delete(),this.gridAggregationModel=this.getAggregationModel(e),this.allAggregationModel||(this.allAggregationModel=this.getAllAggregationModel())}},{key:"setupWeightAttributes",value:function(e){var t=this.state,n=t.weightAttributes,i=t.vertexCount,r=t.weights,o=t.resources;for(var a in r){var s=r[a].values;if(Array.isArray(s)||s.constructor===Float32Array){v.log.assert(s.length/3===i);var l=Array.isArray(s)?new Float32Array(s):s;n[a]instanceof C.Buffer?n[a].setData(l):(o["".concat(a,"-buffer")]=new C.Buffer(this.gl,l),n[a]=o["".concat(a,"-buffer")])}else v.log.assert(s instanceof C.Buffer),n[a]=s}}},{key:"trackGPUResultBuffers",value:function(e,t){var n=this.state.resources;for(var i in e)if(e[i])for(var r=0;r<ae.length;r++){var o=ae[r];if(e[i][o]&&t[i][o]!==e[i][o]){var a="gpu-result-".concat(i,"-").concat(o);n[a]&&n[a].delete(),n[a]=e[i][o]}}}},{key:"updateModels",value:function(e){var t=this.gl,n=e.positions,i=e.positions64xyLow,r=e.changeFlags,o=this.state,a=o.numCol,s=o.numRow,l={},u=!1;if(e.fp64!==this.state.fp64&&(this.setupModels(e.fp64),this.setState({fp64:e.fp64}),u=!0),r.dataChanged||!this.state.positionsBuffer){var c=this.state,g=c.positionsBuffer,h=c.positions64xyLowBuffer;g&&g.delete(),h&&h.delete();var d=n.length/2;g=new C.Buffer(t,new Float32Array(n)),h=new C.Buffer(t,{data:new Float32Array(i),accessor:{size:2}}),this.setState({positionsBuffer:g,positions64xyLowBuffer:h,vertexCount:d}),this.setupWeightAttributes(e),u=!0}if(u){var f=this.state,v=f.vertexCount,p=f.positionsBuffer,m=f.positions64xyLowBuffer;l.positions=p,e.fp64&&(l.positions64xyLow=m),this.gridAggregationModel.setVertexCount(v),this.gridAggregationModel.setAttributes(l)}(r.cellSizeChanged||r.viewportChanged)&&this.allAggregationModel.setInstanceCount(a*s)}}]),e}(),ue=v.experimental.count,ce=[0,0,0,0],ge=[0,255,0,255],he=["minColor","maxColor","colorRange","colorDomain"],de={cellSizePixels:{value:100,min:1},cellMarginPixels:{value:2,min:0,max:5},colorDomain:null,colorRange:p,getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return[1,0,0]}},gpuAggregation:!0,aggregation:"SUM"},fe=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"getShaders",value:function(){var e=Object(C.isWebGL2)(this.context.gl)?{vs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-vertex-shader\n#define RANGE_COUNT 6\n\nin vec3 positions;\nin vec3 instancePositions;\nin vec4 instanceCounts;\nin vec3 instancePickingColors;\n\nlayout(std140) uniform;\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform AggregationData\n{\n  vec4 maxCount;\n} aggregationData;\n\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\n\nout vec4 vColor;\nout float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r ;\n  float maxWeight = aggregationData.maxCount.r;\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#version 300 es\n#define SHADER_NAME screen-grid-layer-fragment-shader\n\nprecision highp float;\n\nin vec4 vColor;\nin float vSampleCount;\nout vec4 fragColor;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  fragColor = vColor;\n\n  fragColor = picking_filterColor(fragColor);\n}\n"}:{vs:"#define SHADER_NAME screen-grid-layer-vertex-shader-webgl1\n#define RANGE_COUNT 6\n\nattribute vec3 positions;\nattribute vec3 instancePositions;\nattribute vec4 instanceCounts;\nattribute vec3 instancePickingColors;\n\nuniform float opacity;\nuniform vec3 cellScale;\nuniform vec4 minColor;\nuniform vec4 maxColor;\nuniform float maxWeight;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 colorDomain;\nuniform bool shouldUseMinMax;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= domain.x && value <= domain.y) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  outColor = outColor / 255.;\n  return outColor;\n}\n\nvoid main(void) {\n  vSampleCount = instanceCounts.a;\n\n  float weight = instanceCounts.r;\n  float step = weight / maxWeight;\n  vec4 minMaxColor = mix(minColor, maxColor, step) / 255.;\n\n  vec2 domain = colorDomain;\n  float domainMaxValid = float(colorDomain.y != 0.);\n  domain.y = mix(maxWeight, colorDomain.y, domainMaxValid);\n  vec4 rangeColor = quantizeScale(domain, colorRange, weight);\n\n  float rangeMinMax = float(shouldUseMinMax);\n  vec4 color = mix(rangeColor, minMaxColor, rangeMinMax);\n  vColor = vec4(color.rgb, color.a * opacity);\n  picking_setPickingColor(instancePickingColors);\n\n  gl_Position = vec4(instancePositions + positions * cellScale, 1.);\n}\n",fs:"#define SHADER_NAME screen-grid-layer-fragment-shader-webgl1\n\nprecision highp float;\n\nvarying vec4 vColor;\nvarying float vSampleCount;\n\nvoid main(void) {\n  if (vSampleCount <= 0.0) {\n    discard;\n  }\n  gl_FragColor = vColor;\n\n  gl_FragColor = picking_filterColor(gl_FragColor);\n}\n"};return e.modules=["picking"],h()(c()(t.prototype),"getShaders",this).call(this,e)}},{key:"initializeState",value:function(){var e=this.getAttributeManager(),t=this.context.gl;e.addInstanced({instancePositions:{size:3,update:this.calculateInstancePositions},instanceCounts:{size:4,transition:!0,accessor:["getPosition","getWeight"],update:this.calculateInstanceCounts,noAlloc:!0}});var n={id:"".concat(this.id,"-aggregator"),shaderCache:this.context.shaderCache},i=this._getMaxCountBuffer(t),r={color:{size:1,operation:I.SUM,needMax:!0,maxBuffer:i}};this.setState({model:this._getModel(t),gpuGridAggregator:new le(t,n),maxBuffer:i,weights:r}),this._setupUniformBuffer()}},{key:"shouldUpdateState",value:function(e){return e.changeFlags.somethingChanged}},{key:"updateState",value:function(e){h()(c()(t.prototype),"updateState",this).call(this,e),this._updateUniforms(e),e.changeFlags.dataChanged&&this._processData();var n=this._getAggregationChangeFlags(e);n&&((n.cellSizeChanged||n.viewportChanged)&&this._updateGridParams(),this.state.pointCount>0&&this._updateAggregation(n))}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this);var e=this.state,n=e.aggregationBuffer,i=e.maxBuffer;e.gpuGridAggregator.delete(),n&&n.delete(),i&&i.delete()}},{key:"draw",value:function(e){var t=e.uniforms,n=this.context.gl,i=this.props.parameters,r=void 0===i?{}:i,o=this.props.minColor||ce,a=this.props.maxColor||ge,s=this.props.colorDomain||[1,0],l=this.state,u=l.model,c=l.maxBuffer,g=l.cellScale,h=l.shouldUseMinMax,d=l.colorRange,f=l.maxWeight,v={minColor:o,maxColor:a,cellScale:g,colorRange:d,colorDomain:s,shouldUseMinMax:h};Object(C.isWebGL2)(n)?c.bind({target:35345}):v.maxWeight=f,t=Object.assign(v,t),u.draw({uniforms:t,parameters:Object.assign({depthTest:!1,depthMask:!1},r)}),Object(C.isWebGL2)(n)&&c.unbind()}},{key:"calculateInstancePositions",value:function(e,t){for(var n=t.numInstances,i=this.context.viewport,r=i.width,o=i.height,a=this.props.cellSizePixels,s=this.state.numCol,l=e.value,u=e.size,c=0;c<n;c++){var g=c%s,h=Math.floor(c/s);l[c*u+0]=g*a/r*2-1,l[c*u+1]=1-h*a/o*2,l[c*u+2]=0}}},{key:"calculateInstanceCounts",value:function(e,t){t.numInstances;var n=this.state.aggregationBuffer;e.update({buffer:n})}},{key:"getPickingInfo",value:function(e){var t=e.info,n=(e.mode,t.index);if(n>=0){var i=this.state.gpuGridAggregator.getData("color");t.object=le.getAggregationData(Object.assign({pixelIndex:n},i))}return t}},{key:"_getAggregationChangeFlags",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r=n.cellSizePixels!==t.cellSizePixels||n.cellMarginPixels!==t.cellMarginPixels,o=i.dataChanged||n.aggregation!==t.aggregation,a=i.viewportChanged;return r||o||a?{cellSizeChanged:r,dataChanged:o,viewportChanged:a}:null}},{key:"_getModel",value:function(e){return new C.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new C.Geometry({drawMode:6,attributes:{positions:new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0])}}),isInstanced:!0,shaderCache:this.context.shaderCache}))}},{key:"_getMaxCountBuffer",value:function(e){return new C.Buffer(e,{byteLength:16,index:0,accessor:{size:4}})}},{key:"_processData",value:function(){var e=this.props,t=e.data,n=e.getPosition,i=e.getWeight,r=ue(t),o=new Float64Array(2*r),a=new Float32Array(3*r),s=this.state.weights,l=Object(v.createIterable)(t),u=l.iterable,c=l.objectInfo,g=!0,h=!1,d=void 0;try{for(var f,p=u[Symbol.iterator]();!(g=(f=p.next()).done);g=!0){var m=f.value;c.index++;var y=n(m,c),x=i(m,c),S=c.index;o[2*S]=y[0],o[2*S+1]=y[1],Array.isArray(x)?(a[3*S]=x[0],a[3*S+1]=x[1],a[3*S+2]=x[2]):a[3*S]=x}}catch(e){h=!0,d=e}finally{try{g||null==p.return||p.return()}finally{if(h)throw d}}s.color.values=a,this.setState({positions:o,pointCount:r})}},{key:"_setupUniformBuffer",value:function(){var e=this.context.gl;if(Object(C.isWebGL2)(e)){var t=this.state.model.program.handle,n=e.getUniformBlockIndex(t,"AggregationData");e.uniformBlockBinding(t,n,0)}}},{key:"_shouldUseMinMax",value:function(){var e=this.props,t=e.minColor,n=e.maxColor,i=e.colorDomain,r=e.colorRange;return t||n?(v.log.deprecated("ScreenGridLayer props: minColor and maxColor","colorRange, colorDomain")(),!0):!i&&!r}},{key:"_updateAggregation",value:function(e){var t=this.getAttributeManager(),n=this.props,i=n.cellSizePixels,r=n.gpuAggregation,o=this.state,a=o.positions,s=o.weights,l=this.context.viewport;s.color.operation=I[this.props.aggregation.toUpperCase()]||I.SUM;var u=!1,c=null;this.context.viewport instanceof v.WebMercatorViewport?u=!0:(u=!1,c=l.pixelProjectionMatrix);var g=this.state.gpuGridAggregator.run({positions:a,weights:s,cellSize:[i,i],viewport:l,changeFlags:e,useGPU:r,projectPoints:u,gridTransformMatrix:c}),h=g.color.maxData&&Number.isFinite(g.color.maxData[0])?g.color.maxData[0]:0;this.setState({maxWeight:h}),t.invalidate("instanceCounts")}},{key:"_updateUniforms",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r={};if(he.some(function(e){return t[e]!==n[e]})&&(r.shouldUseMinMax=this._shouldUseMinMax()),t.colorRange!==n.colorRange&&(r.colorRange=m(n.colorRange)),t.cellMarginPixels!==n.cellMarginPixels||t.cellSizePixels!==n.cellSizePixels||i.viewportChanged){var o=this.context.viewport,a=o.width,s=o.height,l=this.props,u=l.cellSizePixels,c=l.cellMarginPixels,g=u>c?c:0;r.cellScale=new Float32Array([(u-g)/a*2,-(u-g)/s*2,1])}this.setState(r)}},{key:"_updateGridParams",value:function(){this.getAttributeManager().invalidateAll();var e=this.context.viewport,t=e.width,n=e.height,i=this.props.cellSizePixels,r=this.context.gl,o=Math.ceil(t/i),a=Math.ceil(n/i),s=o*a,l=4*s*4,u=this.state.aggregationBuffer;u&&u.delete(),u=new C.Buffer(r,{byteLength:l,accessor:{size:4,type:5126,divisor:1}}),this.state.weights.color.aggregationBuffer=u,this.setState({numCol:o,numRow:a,numInstances:s,aggregationBuffer:u})}}]),t}(v.Layer);fe.layerName="ScreenGridLayer",fe.defaultProps=de;var ve=function(e){return e.length},pe=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:ve;r()(this,e),this.sortedBins=this.getSortedBins(t,n),this.maxCount=this.getMaxCount(),this.binMap=this.getBinMap()}return a()(e,[{key:"getSortedBins",value:function(e,t){return e.reduce(function(e,n,i){var r=t(n.points);return null!=r&&e.push({i:Number.isFinite(n.index)?n.index:i,value:r,counts:n.points.length}),e},[]).sort(function(e,t){return e.value-t.value})}},{key:"getValueRange",value:function(e){var t=b()(e,2),n=t[0],i=t[1],r=this.sortedBins.length;if(!r)return[0,0];var o=Math.ceil(n/100*(r-1)),a=Math.floor(i/100*(r-1));return[this.sortedBins[o].value,this.sortedBins[a].value]}},{key:"getMaxCount",value:function(){var e=0;return this.sortedBins.forEach(function(t){return e=e>t.counts?e:t.counts}),e}},{key:"getBinMap",value:function(){return this.sortedBins.reduce(function(e,t){return Object.assign(e,x()({},t.i,t))},{})}}]),e}();function me(e,t,n){var i=e[1]-e[0];if(i<=0)return v.log.warn("quantizeScale: invalid domain, returning range[0]")(),t[0];var r=i/t.length,o=Math.floor((n-e[0])/r);return t[Math.max(Math.min(o,t.length-1),0)]}function ye(e,t){return function(n){return me(e,t,n)}}function xe(e,t){return function(n){return(n-e[0])/(e[1]-e[0])*(t[1]-t[0])+t[0]}}var Se=6378e3;function be(e,t,n){var i=function(){var e,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],n=arguments.length>1?arguments[1]:void 0,i=arguments.length>2?arguments[2]:void 0,r=1/0,o=-1/0,a=Object(v.createIterable)(t),s=a.iterable,l=a.objectInfo,u=!0,c=!1,g=void 0;try{for(var h,d=s[Symbol.iterator]();!(u=(h=d.next()).done);u=!0){var f=h.value;l.index++,e=i(f,l)[1],Number.isFinite(e)&&(r=e<r?e:r,o=e>o?e:o)}}catch(e){c=!0,g=e}finally{try{u||null==d.return||d.return()}finally{if(c)throw g}}var p=function(e,t){var n=(a=e,a/Se*(180/Math.PI)),i=(r=t,o=e,o/Se*(180/Math.PI)/Math.cos(r*Math.PI/180));var r,o;var a;return{yOffset:n,xOffset:i}}(n,(r+o)/2);if(p.xOffset<=0||p.yOffset<=0)return{gridHash:{},gridOffset:p};var m={};l.index=-1;var y=!0,x=!1,S=void 0;try{for(var C,M=s[Symbol.iterator]();!(y=(C=M.next()).done);y=!0){var w=C.value;l.index++;var E=i(w,l),P=b()(E,2),k=P[0],A=P[1];if(Number.isFinite(A)&&Number.isFinite(k)){var T=Math.floor((A+90)/p.yOffset),D=Math.floor((k+180)/p.xOffset),_="".concat(T,"-").concat(D);m[_]=m[_]||{count:0,points:[]},m[_].count+=1,m[_].points.push(w)}}}catch(e){x=!0,S=e}finally{try{y||null==M.return||M.return()}finally{if(x)throw S}}return{gridHash:m,gridOffset:p}}(e,t,n),r=i.gridHash,o=i.gridOffset;return{gridHash:r,gridOffset:o,layerData:function(e,t){return Object.keys(e).reduce(function(n,i,r){var o=i.split("-"),a=parseInt(o[0],10),s=parseInt(o[1],10);return n.push(Object.assign({index:r,position:[t.xOffset*s-180,t.yOffset*a-90]},e[i])),n},[])}(r,o)}}function Ce(){}var Me={colorDomain:null,colorRange:p,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",lowerPercentile:{type:"number",min:0,max:100,value:0},upperPercentile:{type:"number",min:0,max:100,value:100},onSetColorDomain:Ce,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",min:0,max:100,value:0},elevationUpperPercentile:{type:"number",min:0,max:100,value:100},elevationScale:1,onSetElevationDomain:Ce,cellSize:{type:"number",min:0,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(e){return e.position}},extruded:!1,material:new C.PhongMaterial},we=["getColorValue","colorAggregation","getColorWeight"],Ee=["getElevationValue","elevationAggregation","getElevationWeight"],Pe=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"initializeState",value:function(){this.state={layerData:[],sortedColorBins:null,sortedElevationBins:null,colorValueDomain:null,elevationValueDomain:null,colorScaleFunc:Ce,elevationScaleFunc:Ce,dimensionUpdaters:this.getDimensionUpdaters()}}},{key:"updateState",value:function(e){var t=this,n=e.oldProps,i=e.props,r=e.changeFlags;this.updateGetValueFuncs(n,i);var o=this.needsReProjectPoints(n,i,r);r.dataChanged||o?this.getLayerData():(this.getDimensionChanges(n,i)||[]).forEach(function(e){return"function"==typeof e&&e.apply(t)})}},{key:"colorElevationPropsChanged",value:function(e,t){for(var n=!1,i=!1,r=0;r<we.length;r++){var o=we[r];e[o]!==t[o]&&(n=!0)}for(var a=0;a<Ee.length;a++){var s=Ee[a];e[s]!==t[s]&&(i=!0)}return{colorChanged:n,elevationChanged:i}}},{key:"updateGetValueFuncs",value:function(e,t){var n=t.getColorValue,i=t.getElevationValue,r=this.props,o=r.colorAggregation,a=r.getColorWeight,s=r.elevationAggregation,l=r.getElevationWeight,u=this.colorElevationPropsChanged(e,t),c=u.colorChanged,g=u.elevationChanged;c&&null===n&&(n=q(o,a)),g&&null===i&&(i=q(s,l)),n&&this.setState({getColorValue:n}),i&&this.setState({getElevationValue:i})}},{key:"needsReProjectPoints",value:function(e,t,n){return e.cellSize!==t.cellSize||n.updateTriggersChanged&&(n.updateTriggersChanged.all||n.updateTriggersChanged.getPosition)}},{key:"getDimensionUpdaters",value:function(){return{getFillColor:[{id:"value",triggers:["getColorValue","getColorWeight","colorAggregation"],updater:this.getSortedColorBins},{id:"domain",triggers:["lowerPercentile","upperPercentile"],updater:this.getColorValueDomain},{id:"scaleFunc",triggers:["colorDomain","colorRange"],updater:this.getColorScale}],getElevation:[{id:"value",triggers:["getElevationValue","getElevationWeight","elevationAggregation"],updater:this.getSortedElevationBins},{id:"domain",triggers:["elevationLowerPercentile","elevationUpperPercentile"],updater:this.getElevationValueDomain},{id:"scaleFunc",triggers:["elevationDomain","elevationRange"],updater:this.getElevationScale}]}}},{key:"getDimensionChanges",value:function(e,t){var n=this.state.dimensionUpdaters,i=[];for(var r in n){var o=n[r].find(function(n){return n.triggers.some(function(n){return e[n]!==t[n]})});o&&i.push(o.updater)}return i.length?i:null}},{key:"getPickingInfo",value:function(e){var t=e.info,n=this.state,i=n.sortedColorBins,r=n.sortedElevationBins,o=null;if(t.picked&&t.index>-1){var a=this.state.layerData[t.index],s=i.binMap[a.index]&&i.binMap[a.index].value,l=r.binMap[a.index]&&r.binMap[a.index].value;o=Object.assign({colorValue:s,elevationValue:l},a)}return Object.assign(t,{picked:Boolean(o),object:o})}},{key:"getUpdateTriggers",value:function(){var e=this,t=this.state.dimensionUpdaters,n={},i=function(i){n[i]={};var r=!0,o=!1,a=void 0;try{for(var s,l=t[i][Symbol.iterator]();!(r=(s=l.next()).done);r=!0){s.value.triggers.forEach(function(t){n[i][t]=e.props[t]})}}catch(e){o=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(o)throw a}}};for(var r in t)i(r);return n}},{key:"getLayerData",value:function(){var e=this.props,t=be(e.data,e.cellSize,e.getPosition).layerData;this.setState({layerData:t}),this.getSortedBins()}},{key:"getValueDomain",value:function(){this.getColorValueDomain(),this.getElevationValueDomain()}},{key:"getSortedBins",value:function(){this.getSortedColorBins(),this.getSortedElevationBins()}},{key:"getSortedColorBins",value:function(){var e=this.state.getColorValue,t=new pe(this.state.layerData||[],e);this.setState({sortedColorBins:t}),this.getColorValueDomain()}},{key:"getSortedElevationBins",value:function(){var e=this.state.getElevationValue,t=new pe(this.state.layerData||[],e);this.setState({sortedElevationBins:t}),this.getElevationValueDomain()}},{key:"getColorValueDomain",value:function(){var e=this.props,t=e.lowerPercentile,n=e.upperPercentile,i=e.onSetColorDomain;this.state.colorValueDomain=this.state.sortedColorBins.getValueRange([t,n]),"function"==typeof i&&i(this.state.colorValueDomain),this.getColorScale()}},{key:"getElevationValueDomain",value:function(){var e=this.props,t=e.elevationLowerPercentile,n=e.elevationUpperPercentile,i=e.onSetElevationDomain;this.state.elevationValueDomain=this.state.sortedElevationBins.getValueRange([t,n]),"function"==typeof i&&i(this.state.elevationValueDomain),this.getElevationScale()}},{key:"getColorScale",value:function(){var e=this.props.colorRange,t=this.props.colorDomain||this.state.colorValueDomain;this.state.colorScaleFunc=ye(t,e)}},{key:"getElevationScale",value:function(){var e=this.props.elevationRange,t=this.props.elevationDomain||this.state.elevationValueDomain;this.state.elevationScaleFunc=xe(t,e)}},{key:"_onGetSublayerColor",value:function(e){var t=this.state,n=t.sortedColorBins,i=t.colorScaleFunc,r=t.colorValueDomain,o=n.binMap[e.index]&&n.binMap[e.index].value,a=this.props.colorDomain||r,s=o>=a[0]&&o<=a[a.length-1]?i(o):[0,0,0,0];return s[3]=Number.isFinite(s[3])?s[3]:255,s}},{key:"_onGetSublayerElevation",value:function(e){var t=this.state,n=t.sortedElevationBins,i=t.elevationScaleFunc,r=t.elevationValueDomain,o=n.binMap[e.index]&&n.binMap[e.index].value,a=this.props.elevationDomain||r;return o>=a[0]&&o<=a[a.length-1]?i(o):-1}},{key:"renderLayers",value:function(){var e=this.props,t=e.elevationScale,n=e.extruded,i=e.cellSize,r=e.coverage,o=e.material,a=e.transitions;return new(this.getSubLayerClass("grid-cell",v.GridCellLayer))({cellSize:i,coverage:r,material:o,elevationScale:t,extruded:n,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:a&&{getFillColor:a.getColorValue||a.getColorWeight,getElevation:a.getElevationValue||a.getElevationWeight}},this.getSubLayerProps({id:"grid-cell",updateTriggers:this.getUpdateTriggers()}),{data:this.state.layerData})}}]),t}(v.CompositeLayer);Pe.layerName="CPUGridLayer",Pe.defaultProps=Me;var ke=Math.PI/3,Ae=[0,ke,2*ke,3*ke,4*ke,5*ke];function Te(e){return e[0]}function De(e){return e[1]}var _e=function(){var e,t,n,i=0,r=0,o=1,a=1,s=Te,l=De;function u(e){var i,r={},o=[],a=e.length;for(i=0;i<a;++i)if(!isNaN(c=+s.call(null,u=e[i],i,e))&&!isNaN(g=+l.call(null,u,i,e))){var u,c,g,h=Math.round(g/=n),d=Math.round(c=c/t-(1&h)/2),f=g-h;if(3*Math.abs(f)>1){var v=c-d,p=d+(c<d?-1:1)/2,m=h+(g<h?-1:1),y=c-p,x=g-m;v*v+f*f>y*y+x*x&&(d=p+(1&h?1:-1)/2,h=m)}var S=d+"-"+h,b=r[S];b?b.push(u):(o.push(b=r[S]=[u]),b.x=(d+(1&h)/2)*t,b.y=h*n)}return o}function c(e){var t=0,n=0;return Ae.map(function(i){var r=Math.sin(i)*e,o=-Math.cos(i)*e,a=r-t,s=o-n;return t=r,n=o,[a,s]})}return u.hexagon=function(t){return"m"+c(null==t?e:+t).join("l")+"z"},u.centers=function(){for(var s=[],l=Math.round(r/n),u=Math.round(i/t),c=l*n;c<a+e;c+=n,++l)for(var g=u*t+(1&l)*t/2;g<o+t/2;g+=t)s.push([g,c]);return s},u.mesh=function(){var t=c(e).slice(0,4).join("l");return u.centers().map(function(e){return"M"+e+"m"+t}).join("")},u.x=function(e){return arguments.length?(s=e,u):s},u.y=function(e){return arguments.length?(l=e,u):l},u.radius=function(i){return arguments.length?(t=2*(e=+i)*Math.sin(ke),n=1.5*e,u):e},u.size=function(e){return arguments.length?(i=r=0,o=+e[0],a=+e[1],u):[o-i,a-r]},u.extent=function(e){return arguments.length?(i=+e[0][0],r=+e[0][1],o=+e[1][0],a=+e[1][1],u):[[i,r],[o,a]]},u.radius(1)};function Oe(){}var Ne={colorDomain:null,colorRange:p,getColorValue:{type:"accessor",value:null},getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",lowerPercentile:{type:"number",value:0,min:0,max:100},upperPercentile:{type:"number",value:100,min:0,max:100},onSetColorDomain:Oe,elevationDomain:null,elevationRange:[0,1e3],getElevationValue:{type:"accessor",value:null},getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationLowerPercentile:{type:"number",value:0,min:0,max:100},elevationUpperPercentile:{type:"number",value:100,min:0,max:100},elevationScale:{type:"number",min:0,value:1},onSetElevationDomain:Oe,radius:{type:"number",value:1e3,min:1},coverage:{type:"number",min:0,max:1,value:1},extruded:!1,hexagonAggregator:function(e,t){var n=e.data,i=e.radius,r=e.getPosition,o=function(e,t){var n=t.getDistanceScales().pixelsPerMeter;return e*n[0]}(i,t),a=[],s=Object(v.createIterable)(n),l=s.iterable,u=s.objectInfo,c=!0,g=!1,h=void 0;try{for(var d,f=l[Symbol.iterator]();!(c=(d=f.next()).done);c=!0){var p=d.value;u.index++;var m=r(p,u);Number.isFinite(m[0])&&Number.isFinite(m[1])?a.push(Object.assign({screenCoord:t.projectFlat(m)},p)):v.log.warn("HexagonLayer: invalid position")()}}catch(e){g=!0,h=e}finally{try{c||null==f.return||f.return()}finally{if(g)throw h}}return{hexagons:_e().radius(o).x(function(e){return e.screenCoord[0]}).y(function(e){return e.screenCoord[1]})(a).map(function(e,n){return{position:t.unprojectFlat([e.x,e.y]),points:e,index:n}})}},getPosition:{type:"accessor",value:function(e){return e.position}},material:new C.PhongMaterial},ze=["getColorValue","colorAggregation","getColorWeight"],Be=["getElevationValue","elevationAggregation","getElevationWeight"],Fe=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"initializeState",value:function(){this.state={hexagons:[],sortedColorBins:null,sortedElevationBins:null,colorValueDomain:null,elevationValueDomain:null,colorScaleFunc:Oe,elevationScaleFunc:Oe,dimensionUpdaters:this.getDimensionUpdaters()}}},{key:"updateState",value:function(e){var t=this,n=e.oldProps,i=e.props,r=e.changeFlags;this.updateGetValueFuncs(n,i);var o=this.getDimensionChanges(n,i);r.dataChanged||this.needsReProjectPoints(n,i)?this.getHexagons():o&&o.forEach(function(e){return"function"==typeof e&&e.apply(t)})}},{key:"colorElevationPropsChanged",value:function(e,t){for(var n=!1,i=!1,r=0;r<ze.length;r++){var o=ze[r];e[o]!==t[o]&&(n=!0)}for(var a=0;a<Be.length;a++){var s=Be[a];e[s]!==t[s]&&(i=!0)}return{colorChanged:n,elevationChanged:i}}},{key:"updateGetValueFuncs",value:function(e,t){var n=t.getColorValue,i=t.getElevationValue,r=this.props,o=r.colorAggregation,a=r.getColorWeight,s=r.elevationAggregation,l=r.getElevationWeight,u=this.colorElevationPropsChanged(e,t),c=u.colorChanged,g=u.elevationChanged;c&&null===n&&(n=q(o,a)),g&&null===i&&(i=q(s,l)),n&&this.setState({getColorValue:n}),i&&this.setState({getElevationValue:i})}},{key:"needsReProjectPoints",value:function(e,t){return e.radius!==t.radius||e.hexagonAggregator!==t.hexagonAggregator}},{key:"getDimensionUpdaters",value:function(){return{getFillColor:[{id:"value",triggers:["getColorValue","getColorWeight","colorAggregation"],updater:this.getSortedColorBins},{id:"domain",triggers:["lowerPercentile","upperPercentile"],updater:this.getColorValueDomain},{id:"scaleFunc",triggers:["colorDomain","colorRange"],updater:this.getColorScale}],getElevation:[{id:"value",triggers:["getElevationValue","getElevationWeight","elevationAggregation"],updater:this.getSortedElevationBins},{id:"domain",triggers:["elevationLowerPercentile","elevationUpperPercentile"],updater:this.getElevationValueDomain},{id:"scaleFunc",triggers:["elevationDomain","elevationRange"],updater:this.getElevationScale}]}}},{key:"getDimensionChanges",value:function(e,t){var n=this.state.dimensionUpdaters,i=[];for(var r in n){var o=n[r].find(function(n){return n.triggers.some(function(n){return e[n]!==t[n]})});o&&i.push(o.updater)}return i.length?i:null}},{key:"getHexagons",value:function(){var e=this.props.hexagonAggregator,t=this.context.viewport,n=e(this.props,t),i=n.hexagons,r=n.hexagonVertices;this.updateRadiusAngle(r),this.setState({hexagons:i}),this.getSortedBins()}},{key:"getPickingInfo",value:function(e){var t=e.info,n=this.state,i=n.sortedColorBins,r=n.sortedElevationBins,o=null;if(t.picked&&t.index>-1){var a=this.state.hexagons[t.index],s=i.binMap[a.index]&&i.binMap[a.index].value,l=r.binMap[a.index]&&r.binMap[a.index].value;o=Object.assign({colorValue:s,elevationValue:l},a)}return Object.assign(t,{picked:Boolean(o),object:o})}},{key:"getUpdateTriggers",value:function(){var e=this,t=this.state.dimensionUpdaters,n={},i=function(i){n[i]={};var r=!0,o=!1,a=void 0;try{for(var s,l=t[i][Symbol.iterator]();!(r=(s=l.next()).done);r=!0){s.value.triggers.forEach(function(t){n[i][t]=e.props[t]})}}catch(e){o=!0,a=e}finally{try{r||null==l.return||l.return()}finally{if(o)throw a}}};for(var r in t)i(r);return n}},{key:"updateRadiusAngle",value:function(e){var t=this.props.radius,n=90;if(Array.isArray(e)){e.length<6&&v.log.error("HexagonCellLayer: hexagonVertices needs to be an array of 6 points")();var i=e[0],r=e[3],o=this.context.viewport.getDistanceScales().pixelsPerMeter,a=this.projectFlat(i),s=this.projectFlat(r),l=a[0]-s[0],u=a[1]-s[1],c=Math.sqrt(l*l+u*u);n=Math.acos(l/c)*-Math.sign(u)/Math.PI*180+90,t=c/2/o[0]}this.setState({angle:n,radius:t})}},{key:"getValueDomain",value:function(){this.getColorValueDomain(),this.getElevationValueDomain()}},{key:"getSortedBins",value:function(){this.getSortedColorBins(),this.getSortedElevationBins()}},{key:"getSortedColorBins",value:function(){var e=this.state.getColorValue,t=new pe(this.state.hexagons||[],e);this.setState({sortedColorBins:t}),this.getColorValueDomain()}},{key:"getSortedElevationBins",value:function(){var e=this.state.getElevationValue,t=new pe(this.state.hexagons||[],e);this.setState({sortedElevationBins:t}),this.getElevationValueDomain()}},{key:"getColorValueDomain",value:function(){var e=this.props,t=e.lowerPercentile,n=e.upperPercentile,i=e.onSetColorDomain;t>n&&v.log.warn("HexagonLayer: lowerPercentile is bigger than upperPercentile")(),this.state.colorValueDomain=this.state.sortedColorBins.getValueRange([t,n]),"function"==typeof i&&i(this.state.colorValueDomain),this.getColorScale()}},{key:"getElevationValueDomain",value:function(){var e=this.props,t=e.elevationLowerPercentile,n=e.elevationUpperPercentile,i=e.onSetElevationDomain;this.state.elevationValueDomain=this.state.sortedElevationBins.getValueRange([t,n]),"function"==typeof i&&i(this.state.elevationValueDomain),this.getElevationScale()}},{key:"getColorScale",value:function(){var e=this.props.colorRange,t=this.props.colorDomain||this.state.colorValueDomain;this.state.colorScaleFunc=ye(t,e)}},{key:"getElevationScale",value:function(){var e=this.props.elevationRange,t=this.props.elevationDomain||this.state.elevationValueDomain;this.state.elevationScaleFunc=xe(t,e)}},{key:"_onGetSublayerColor",value:function(e){var t=this.state,n=t.sortedColorBins,i=t.colorScaleFunc,r=t.colorValueDomain,o=n.binMap[e.index]&&n.binMap[e.index].value,a=this.props.colorDomain||r,s=o>=a[0]&&o<=a[a.length-1]?i(o):[0,0,0,0];return s[3]=Number.isFinite(s[3])?s[3]:255,s}},{key:"_onGetSublayerElevation",value:function(e){var t=this.state,n=t.sortedElevationBins,i=t.elevationScaleFunc,r=t.elevationValueDomain,o=n.binMap[e.index]&&n.binMap[e.index].value,a=this.props.elevationDomain||r;return o>=a[0]&&o<=a[a.length-1]?i(o):-1}},{key:"renderLayers",value:function(){var e=this.props,t=e.elevationScale,n=e.extruded,i=e.coverage,r=e.material,o=e.transitions,a=this.state,s=a.angle,l=a.radius;return new(this.getSubLayerClass("hexagon-cell",v.ColumnLayer))({radius:l,diskResolution:6,elevationScale:t,angle:s,extruded:n,coverage:i,material:r,getFillColor:this._onGetSublayerColor.bind(this),getElevation:this._onGetSublayerElevation.bind(this),transitions:o&&{getFillColor:o.getColorValue||o.getColorWeight,getElevation:o.getElevationValue||o.getElevationWeight}},this.getSubLayerProps({id:"hexagon-cell",updateTriggers:this.getUpdateTriggers()}),{data:this.state.hexagons})}}]),t}(v.CompositeLayer);Fe.layerName="HexagonLayer",Fe.defaultProps=Ne;var Le,je={};function Re(e){if(!Number.isFinite(e))throw new Error("Invalid number ".concat(e));return e}function We(e){return Math.round(e/je.EPSILON)*je.EPSILON}function Ie(e){var t=(arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}).precision,n=void 0===t?je.precision||4:t;return e=We(e),parseFloat(e.toPrecision(n))}function Ue(e){return Array.isArray(e)||ArrayBuffer.isView(e)&&void 0!==e.length}function Ve(e,t){if(Ue(e)&&Ue(t)){if(e===t)return!0;if(e.length!==t.length)return!1;for(var n=0;n<e.length;++n)if(!Ve(e[n],t[n]))return!1;return!0}return Math.abs(e-t)<=je.EPSILON*Math.max(1,Math.abs(e),Math.abs(t))}je.EPSILON=1e-12,je.debug=!0,je.precision=4,je.printTypes=!1,je.printDegrees=!1,je.printRowMajor=!0;var Ge={N:[0,.5],E:[.5,0],S:[0,-.5],W:[-.5,0],NE:[.5,.5],NW:[-.5,.5],SE:[.5,-.5],SW:[-.5,-.5]},qe=[Ge.W,Ge.SW,Ge.S],Ye=[Ge.S,Ge.SE,Ge.E],Xe=[Ge.E,Ge.NE,Ge.N],He=[Ge.NW,Ge.W,Ge.N],Ze=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5]],Ke=[[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6]],Qe=[[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],Je=[[-.5,1/6],[-.5,-1/6],[1/6,.5],[-1/6,.5]],$e=[Ge.W,Ge.SW,Ge.SE,Ge.E],et=[Ge.S,Ge.SE,Ge.NE,Ge.N],tt=[Ge.NW,Ge.W,Ge.E,Ge.NE],nt=[Ge.NW,Ge.SW,Ge.S,Ge.N],it=[[-.5,1/6],[-.5,-1/6],[.5,-1/6],[.5,1/6]],rt=[[-1/6,-.5],[1/6,-.5],[1/6,.5],[-1/6,.5]],ot=[Ge.NW,Ge.SW,Ge.SE,Ge.NE],at=[Ge.NW,Ge.SW,Ge.SE,Ge.E,Ge.N],st=[Ge.W,Ge.SW,Ge.SE,Ge.NE,Ge.N],lt=[Ge.NW,Ge.W,Ge.S,Ge.SE,Ge.NE],ut=[Ge.NW,Ge.SW,Ge.S,Ge.E,Ge.NE],ct=[Ge.NW,Ge.W,[.5,-1/6],[.5,1/6],Ge.N],gt=[[-1/6,-.5],[1/6,-.5],Ge.E,Ge.NE,Ge.N],ht=[[-.5,1/6],[-.5,-1/6],Ge.S,Ge.SE,Ge.E],dt=[Ge.W,Ge.SW,Ge.S,[1/6,.5],[-1/6,.5]],ft=[Ge.NW,Ge.W,[-1/6,-.5],[1/6,-.5],Ge.N],vt=[[-.5,1/6],[-.5,-1/6],Ge.E,Ge.NE,Ge.N],pt=[Ge.S,Ge.SE,Ge.E,[1/6,.5],[-1/6,.5]],mt=[Ge.W,Ge.SW,Ge.S,[.5,-1/6],[.5,1/6]],yt=[Ge.W,Ge.SW,Ge.SE,Ge.E,[1/6,.5],[-1/6,.5]],xt=[[-.5,1/6],[-.5,-1/6],Ge.S,Ge.SE,Ge.NE,Ge.N],St=[Ge.NW,Ge.W,[-1/6,-.5],[1/6,-.5],Ge.E,Ge.NE],bt=[Ge.NW,Ge.SW,Ge.S,[.5,-1/6],[.5,1/6],Ge.N],Ct=[Ge.W,Ge.SW,Ge.S,Ge.E,Ge.NE,Ge.N],Mt=[Ge.NW,Ge.W,Ge.S,Ge.SE,Ge.E,Ge.N],wt=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5],Ge.E,Ge.NE,Ge.N],Et=[Ge.W,Ge.SW,Ge.S,[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],Pt=[Ge.NW,Ge.W,[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6],Ge.N],kt=[[-.5,1/6],[-.5,-1/6],Ge.S,Ge.SE,Ge.E,[1/6,.5],[-1/6,.5]],At=[[-.5,1/6],[-.5,-1/6],[-1/6,-.5],[1/6,-.5],[.5,-1/6],[.5,1/6],[1/6,.5],[-1/6,.5]],Tt={0:[],1:[[Ge.W,Ge.S]],2:[[Ge.S,Ge.E]],3:[[Ge.W,Ge.E]],4:[[Ge.N,Ge.E]],5:{0:[[Ge.W,Ge.S],[Ge.N,Ge.E]],1:[[Ge.W,Ge.N],[Ge.S,Ge.E]]},6:[[Ge.N,Ge.S]],7:[[Ge.W,Ge.N]],8:[[Ge.W,Ge.N]],9:[[Ge.N,Ge.S]],10:{0:[[Ge.W,Ge.N],[Ge.S,Ge.E]],1:[[Ge.W,Ge.S],[Ge.N,Ge.E]]},11:[[Ge.N,Ge.E]],12:[[Ge.W,Ge.E]],13:[[Ge.S,Ge.E]],14:[[Ge.W,Ge.S]],15:[]};function Dt(e){return parseInt(e,4)}var _t=(Le={},x()(Le,Dt("0000"),[]),x()(Le,Dt("2222"),[]),x()(Le,Dt("2221"),[qe]),x()(Le,Dt("2212"),[Ye]),x()(Le,Dt("2122"),[Xe]),x()(Le,Dt("1222"),[He]),x()(Le,Dt("0001"),[qe]),x()(Le,Dt("0010"),[Ye]),x()(Le,Dt("0100"),[Xe]),x()(Le,Dt("1000"),[He]),x()(Le,Dt("2220"),[Ze]),x()(Le,Dt("2202"),[Ke]),x()(Le,Dt("2022"),[Qe]),x()(Le,Dt("0222"),[Je]),x()(Le,Dt("0002"),[Ze]),x()(Le,Dt("0020"),[Ke]),x()(Le,Dt("0200"),[Qe]),x()(Le,Dt("2000"),[Je]),x()(Le,Dt("0011"),[$e]),x()(Le,Dt("0110"),[et]),x()(Le,Dt("1100"),[tt]),x()(Le,Dt("1001"),[nt]),x()(Le,Dt("2211"),[$e]),x()(Le,Dt("2112"),[et]),x()(Le,Dt("1122"),[tt]),x()(Le,Dt("1221"),[nt]),x()(Le,Dt("2200"),[it]),x()(Le,Dt("2002"),[rt]),x()(Le,Dt("0022"),[it]),x()(Le,Dt("0220"),[rt]),x()(Le,Dt("1111"),[ot]),x()(Le,Dt("1211"),[at]),x()(Le,Dt("2111"),[st]),x()(Le,Dt("1112"),[lt]),x()(Le,Dt("1121"),[ut]),x()(Le,Dt("1011"),[at]),x()(Le,Dt("0111"),[st]),x()(Le,Dt("1110"),[lt]),x()(Le,Dt("1101"),[ut]),x()(Le,Dt("1200"),[ct]),x()(Le,Dt("0120"),[gt]),x()(Le,Dt("0012"),[ht]),x()(Le,Dt("2001"),[dt]),x()(Le,Dt("1022"),[ct]),x()(Le,Dt("2102"),[gt]),x()(Le,Dt("2210"),[ht]),x()(Le,Dt("0221"),[dt]),x()(Le,Dt("1002"),[ft]),x()(Le,Dt("2100"),[vt]),x()(Le,Dt("0210"),[pt]),x()(Le,Dt("0021"),[mt]),x()(Le,Dt("1220"),[ft]),x()(Le,Dt("0122"),[vt]),x()(Le,Dt("2012"),[pt]),x()(Le,Dt("2201"),[mt]),x()(Le,Dt("0211"),[yt]),x()(Le,Dt("2110"),[xt]),x()(Le,Dt("1102"),[St]),x()(Le,Dt("1021"),[bt]),x()(Le,Dt("2011"),[yt]),x()(Le,Dt("0112"),[xt]),x()(Le,Dt("1120"),[St]),x()(Le,Dt("1201"),[bt]),x()(Le,Dt("2101"),[Ct]),x()(Le,Dt("0121"),[Ct]),x()(Le,Dt("1012"),[Mt]),x()(Le,Dt("1210"),[Mt]),x()(Le,Dt("0101"),{0:[qe,Xe],1:[Ct],2:[Ct]}),x()(Le,Dt("1010"),{0:[He,Ye],1:[Mt],2:[Mt]}),x()(Le,Dt("2121"),{0:[Ct],1:[Ct],2:[qe,Xe]}),x()(Le,Dt("1212"),{0:[Mt],1:[Mt],2:[He,Ye]}),x()(Le,Dt("2120"),{0:[wt],1:[wt],2:[Ze,Xe]}),x()(Le,Dt("2021"),{0:[Et],1:[Et],2:[qe,Qe]}),x()(Le,Dt("1202"),{0:[Pt],1:[Pt],2:[He,Ke]}),x()(Le,Dt("0212"),{0:[kt],1:[kt],2:[Ye,Je]}),x()(Le,Dt("0102"),{0:[Ze,Xe],1:[wt],2:[wt]}),x()(Le,Dt("0201"),{0:[qe,Qe],1:[Et],2:[Et]}),x()(Le,Dt("1020"),{0:[He,Ke],1:[Pt],2:[Pt]}),x()(Le,Dt("2010"),{0:[Ye,Je],1:[kt],2:[kt]}),x()(Le,Dt("2020"),{0:[Je,Ke],1:[At],2:[Ze,Qe]}),x()(Le,Dt("0202"),{0:[Qe,Ze],1:[At],2:[Je,Ke]}),Le),Ot={ISO_LINES:1,ISO_BANDS:2},Nt={zIndex:0,zOffset:.005};function zt(e,t){return Array.isArray(t)?e<t[0]?0:e<t[1]?1:2:e>=t?1:0}function Bt(e){var t=e.cellWeights,n=e.x,i=e.y,r=e.width,o=e.height,a=e.threshold;e.thresholdValue&&(v.log.deprecated("thresholdValue","threshold")(),a=e.thresholdValue);var s=n<0,l=n>=r-1,u=i<0,c=i>=o-1,g=s||l||u||c,h={},d={};s||c?d.top=0:(h.top=t[(i+1)*r+n],d.top=zt(h.top,a)),l||c?d.topRight=0:(h.topRight=t[(i+1)*r+n+1],d.topRight=zt(h.topRight,a)),l||u?d.right=0:(h.right=t[i*r+n+1],d.right=zt(h.right,a)),s||u?d.current=0:(h.current=t[i*r+n],d.current=zt(h.current,a));var f=d.top,p=d.topRight,m=d.right,y=d.current,x=-1;Number.isFinite(a)&&(x=f<<3|p<<2|m<<1|y),Array.isArray(a)&&(x=f<<6|p<<4|m<<2|y);var S=0;return g||(S=zt((h.top+h.topRight+h.right+h.current)/4,a)),{code:x,meanCode:S}}function Ft(e){var t=e.gridOrigin,n=e.cellSize,i=e.x,r=e.y,o=e.code,a=e.meanCode,s=e.type,l=void 0===s?Ot.ISO_LINES:s,u=Object.assign({},Nt,e.thresholdData),c=l===Ot.ISO_BANDS?_t[o]:Tt[o];Array.isArray(c)||(c=c[a]);var g=u.zIndex*u.zOffset,h=(i+1)*n[0],d=(r+1)*n[1],f=t[0]+h,v=t[1]+d;if(l===Ot.ISO_BANDS){var p=[];return c.forEach(function(e){var t=[];e.forEach(function(e){var i=f+e[0]*n[0],r=v+e[1]*n[1];t.push([i,r,g])}),p.push(t)}),p}var m=[];return c.forEach(function(e){e.forEach(function(e){var t=f+e[0]*n[0],i=v+e[1]*n[1];m.push([t,i,g])})}),m}function Lt(e){return function(e){if(Array.isArray(e)){for(var t=0,n=new Array(e.length);t<e.length;t++)n[t]=e[t];return n}}(e)||function(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function jt(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function Rt(e,t){for(var n=0;n<t.length;n++){var i=t[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function Wt(e,t,n){return t&&Rt(e.prototype,t),n&&Rt(e,n),e}function It(e){return(It="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function Ut(e){return(Ut="function"==typeof Symbol&&"symbol"===It(Symbol.iterator)?function(e){return It(e)}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":It(e)})(e)}function Vt(e,t){return!t||"object"!==Ut(t)&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}function Gt(e){return(Gt=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function qt(e,t){return(qt=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function Yt(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&qt(e,t)}function Xt(e){function t(){var t=Reflect.construct(e,Array.from(arguments));return Object.setPrototypeOf(t,Object.getPrototypeOf(this)),t}return t.prototype=Object.create(e.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e,t}var Ht=function(e){function t(){return jt(this,t),Vt(this,Gt(t).apply(this,arguments))}return Yt(t,Xt(Array)),Wt(t,[{key:"clone",value:function(){return(new this.constructor).copy(this).check()}},{key:"copy",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=e[t];return this.check()}},{key:"set",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=(e<0||arguments.length<=e?void 0:arguments[e])||0;return this.check()}},{key:"fromArray",value:function(e){for(var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=0;n<this.ELEMENTS;++n)this[n]=e[n+t];return this.check()}},{key:"toString",value:function(){return this.formatString(je)}},{key:"formatString",value:function(e){for(var t="",n=0;n<this.ELEMENTS;++n)t+=(n>0?", ":"")+Ie(this[n],e);return"".concat(e.printTypes?this.constructor.name:"","[").concat(t,"]")}},{key:"toArray",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=0;n<this.ELEMENTS;++n)e[t+n]=this[n];return e}},{key:"toFloat32Array",value:function(){return new Float32Array(this)}},{key:"equals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(!Ve(this[t],e[t]))return!1;return!0}},{key:"exactEquals",value:function(e){if(!e||this.length!==e.length)return!1;for(var t=0;t<this.ELEMENTS;++t)if(this[t]!==e[t])return!1;return!0}},{key:"negate",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=-this[e];return this.check()}},{key:"inverse",value:function(){for(var e=0;e<this.ELEMENTS;++e)this[e]=1/this[e];return this.check()}},{key:"lerp",value:function(e,t,n){void 0===n&&(n=t,t=e,e=this);for(var i=0;i<this.ELEMENTS;++i){var r=e[i];this[i]=r+n*(t[i]-r)}return this.check()}},{key:"min",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.min(e[t],this[t]);return this.check()}},{key:"max",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=Math.max(e[t],this[t]);return this.check()}},{key:"clamp",value:function(e,t){for(var n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e[n]),t[n]);return this.check()}},{key:"validate",value:function(){for(var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this,t=e&&e.length===this.ELEMENTS,n=0;n<this.ELEMENTS;++n)t=t&&Number.isFinite(e[n]);return t}},{key:"check",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this;if(je.debug&&!this.validate(e))throw new Error("math.gl: ".concat(this.constructor.name," some fields set to invalid numbers'"));return this}},{key:"sub",value:function(e){return this.subtract(e)}},{key:"setScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]=e;return this.check()}},{key:"addScalar",value:function(e){for(var t=0;t<this.ELEMENTS;++t)this[t]+=e;return this.check()}},{key:"subScalar",value:function(e){return this.addScalar(-e)}},{key:"multiplyScalar",value:function(e){return this.scale(e)}},{key:"divideScalar",value:function(e){return this.scale(1/e)}},{key:"clampScalar",value:function(e,t){for(var n=0;n<this.ELEMENTS;++n)this[n]=Math.min(Math.max(this[n],e),t);return this.check()}}]),t}();function Zt(e,t){return e.length===t&&e.every(Number.isFinite)}var Kt=function(e,t){if(!e)throw new Error(t)},Qt=function(e){function t(){return jt(this,t),Vt(this,Gt(t).apply(this,arguments))}return Yt(t,Ht),Wt(t,[{key:"len",value:function(){return Math.sqrt(this.lengthSquared())}},{key:"magnitude",value:function(){return Math.sqrt(this.lengthSquared())}},{key:"lengthSquared",value:function(){for(var e=0,t=0;t<this.ELEMENTS;++t)e+=this[t]*this[t];return e}},{key:"distance",value:function(e){return Math.sqrt(this.distanceSquared(e))}},{key:"distanceSquared",value:function(e){for(var t=0,n=0;n<this.ELEMENTS;++n){var i=this[n]-e[n];t+=i*i}return Re(t)}},{key:"dot",value:function(e){for(var t=0,n=0;n<this.ELEMENTS;++n)t+=this[n]*e[n];return Re(t)}},{key:"normalize",value:function(){var e=this.magnitude();if(0!==e)for(var t=0;t<this.ELEMENTS;++t)this[t]/=e;return this.check()}},{key:"add",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0;i<t.length;i++)for(var r=t[i],o=0;o<this.ELEMENTS;++o)this[o]+=r[o];return this.check()}},{key:"subtract",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0;i<t.length;i++)for(var r=t[i],o=0;o<this.ELEMENTS;++o)this[o]-=r[o];return this.check()}},{key:"multiply",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0;i<t.length;i++)for(var r=t[i],o=0;o<this.ELEMENTS;++o)this[o]*=r[o];return this.check()}},{key:"divide",value:function(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];for(var i=0;i<t.length;i++)for(var r=t[i],o=0;o<this.ELEMENTS;++o)this[o]/=r[o];return this.check()}},{key:"scale",value:function(e){if(Array.isArray(e))return this.multiply(e);for(var t=0;t<this.ELEMENTS;++t)this[t]*=e;return this.check()}},{key:"scaleAndAdd",value:function(e,t){for(var n=0;n<this.ELEMENTS;++n)this[n]=this[n]*t+e[n];return this.check()}},{key:"lengthSq",value:function(){return this.lengthSquared()}},{key:"distanceTo",value:function(e){return this.distance(e)}},{key:"distanceToSquared",value:function(e){return this.distanceSquared(e)}},{key:"getComponent",value:function(e){return Kt(e>=0&&e<this.ELEMENTS,"index is out of range"),Re(this[e])}},{key:"setComponent",value:function(e,t){return Kt(e>=0&&e<this.ELEMENTS,"index is out of range"),this[e]=t,this.check()}},{key:"addVectors",value:function(e,t){return this.copy(e).add(t)}},{key:"subVectors",value:function(e,t){return this.copy(e).subtract(t)}},{key:"multiplyVectors",value:function(e,t){return this.copy(e).multiply(t)}},{key:"addScaledVector",value:function(e,t){return this.add(new this.constructor(e).multiplyScalar(t))}},{key:"x",get:function(){return this[0]},set:function(e){return this[0]=Re(e)}},{key:"y",get:function(){return this[1]},set:function(e){return this[1]=Re(e)}}]),t}(),Jt=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return jt(this,t),e=Vt(this,Gt(t).call(this)),Array.isArray(n)&&1===arguments.length?e.copy(n):e.set(n,i),e}return Yt(t,Qt),Wt(t,[{key:"cross",value:function(e){var t,n,i,r;return t=this,i=e,r=(n=this)[0]*i[1]-n[1]*i[0],t[0]=t[1]=0,t[2]=r,this.check()}},{key:"horizontalAngle",value:function(){return Math.atan2(this.y,this.x)}},{key:"verticalAngle",value:function(){return Math.atan2(this.x,this.y)}},{key:"operation",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return e.apply(void 0,[this,this].concat(n)),this.check()}},{key:"ELEMENTS",get:function(){return 2}}]),t}(),$t=[0,0,0],en=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;return jt(this,t),e=Vt(this,Gt(t).call(this)),Array.isArray(n)&&1===arguments.length?e.copy(n):e.set(n,i,r),e}return Yt(t,Qt),Wt(t,[{key:"angle",value:function(e){return function(e,t){var n=F(e[0],e[1],e[2]),i=F(t[0],t[1],t[2]);L(n,n),L(i,i);var r=function(e,t){return e[0]*t[0]+e[1]*t[1]+e[2]*t[2]}(n,i);return r>1?0:r<-1?Math.PI:Math.acos(r)}(this,e)}},{key:"cross",value:function(e){var t,n,i,r,o,a,s,l,u;return t=this,i=e,r=(n=this)[0],o=n[1],a=n[2],s=i[0],l=i[1],u=i[2],t[0]=o*u-a*l,t[1]=a*s-r*u,t[2]=r*l-o*s,this.check()}},{key:"rotateX",value:function(e){var t,n,i,r,o,a,s=e.radians,l=e.origin;return t=this,i=void 0===l?$t:l,r=s,a=[],(o=[])[0]=(n=this)[0]-i[0],o[1]=n[1]-i[1],o[2]=n[2]-i[2],a[0]=o[0],a[1]=o[1]*Math.cos(r)-o[2]*Math.sin(r),a[2]=o[1]*Math.sin(r)+o[2]*Math.cos(r),t[0]=a[0]+i[0],t[1]=a[1]+i[1],t[2]=a[2]+i[2],this.check()}},{key:"rotateY",value:function(e){var t,n,i,r,o,a,s=e.radians,l=e.origin;return t=this,i=void 0===l?$t:l,r=s,a=[],(o=[])[0]=(n=this)[0]-i[0],o[1]=n[1]-i[1],o[2]=n[2]-i[2],a[0]=o[2]*Math.sin(r)+o[0]*Math.cos(r),a[1]=o[1],a[2]=o[2]*Math.cos(r)-o[0]*Math.sin(r),t[0]=a[0]+i[0],t[1]=a[1]+i[1],t[2]=a[2]+i[2],this.check()}},{key:"rotateZ",value:function(e){var t,n,i,r,o,a,s=e.radians,l=e.origin;return t=this,i=void 0===l?$t:l,r=s,a=[],(o=[])[0]=(n=this)[0]-i[0],o[1]=n[1]-i[1],o[2]=n[2]-i[2],a[0]=o[0]*Math.cos(r)-o[1]*Math.sin(r),a[1]=o[0]*Math.sin(r)+o[1]*Math.cos(r),a[2]=o[2],t[0]=a[0]+i[0],t[1]=a[1]+i[1],t[2]=a[2]+i[2],this.check()}},{key:"operation",value:function(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];return e.apply(void 0,[this,this].concat(n)),this.check()}},{key:"ELEMENTS",get:function(){return 3}},{key:"z",get:function(){return this[2]},set:function(e){return this[2]=Re(e)}}]),t}(),tn=function(e){function t(){var e,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0;return jt(this,t),e=Vt(this,Gt(t).call(this)),Array.isArray(n)&&1===arguments.length?e.copy(n):e.set(n,i,r,o),e}return Yt(t,Qt),Wt(t,[{key:"applyMatrix4",value:function(e){return e.transformVector(this,this),this}},{key:"ELEMENTS",get:function(){return 4}},{key:"z",get:function(){return this[2]},set:function(e){return this[2]=Re(e)}},{key:"w",get:function(){return this[3]},set:function(e){return this[3]=Re(e)}}]),t}(),nn=[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1];var rn=function(e){function t(){for(var e,n=arguments.length,i=new Array(n),r=0;r<n;r++)i[r]=arguments[r];return jt(this,t),e=Vt(this,Gt(t).call(this)),Array.isArray(i[0])&&1===arguments.length?e.copy(i[0]):e.identity(),e}return Yt(t,Ht),Wt(t,[{key:"setRowMajor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,g=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,h=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,f=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,v=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return this[0]=e,this[1]=r,this[2]=l,this[3]=h,this[4]=t,this[5]=o,this[6]=u,this[7]=d,this[8]=n,this[9]=a,this[10]=c,this[11]=f,this[12]=i,this[13]=s,this[14]=g,this[15]=v,this.check()}},{key:"setColumnMajor",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:0,r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:0,o=arguments.length>5&&void 0!==arguments[5]?arguments[5]:1,a=arguments.length>6&&void 0!==arguments[6]?arguments[6]:0,s=arguments.length>7&&void 0!==arguments[7]?arguments[7]:0,l=arguments.length>8&&void 0!==arguments[8]?arguments[8]:0,u=arguments.length>9&&void 0!==arguments[9]?arguments[9]:0,c=arguments.length>10&&void 0!==arguments[10]?arguments[10]:1,g=arguments.length>11&&void 0!==arguments[11]?arguments[11]:0,h=arguments.length>12&&void 0!==arguments[12]?arguments[12]:0,d=arguments.length>13&&void 0!==arguments[13]?arguments[13]:0,f=arguments.length>14&&void 0!==arguments[14]?arguments[14]:0,v=arguments.length>15&&void 0!==arguments[15]?arguments[15]:1;return this[0]=e,this[1]=t,this[2]=n,this[3]=i,this[4]=r,this[5]=o,this[6]=a,this[7]=s,this[8]=l,this[9]=u,this[10]=c,this[11]=g,this[12]=h,this[13]=d,this[14]=f,this[15]=v,this.check()}},{key:"copy",value:function(e){return this.setColumnMajor.apply(this,Lt(e))}},{key:"set",value:function(){return this.setColumnMajor.apply(this,arguments)}},{key:"getElement",value:function(e,t){return arguments.length>2&&void 0!==arguments[2]&&arguments[2]?this[e][t]:this[t][e]}},{key:"setElement",value:function(e,t,n){return arguments.length>3&&void 0!==arguments[3]&&arguments[3]?this[e][t]=Re(n):this[t][e]=Re(n),this}},{key:"determinant",value:function(){return t=(e=this)[0],n=e[1],i=e[2],r=e[3],o=e[4],a=e[5],s=e[6],l=e[7],u=e[8],c=e[9],g=e[10],h=e[11],d=e[12],f=e[13],v=e[14],p=e[15],(t*a-n*o)*(g*p-h*v)-(t*s-i*o)*(c*p-h*f)+(t*l-r*o)*(c*v-g*f)+(n*s-i*a)*(u*p-h*d)-(n*l-r*a)*(u*v-g*d)+(i*l-r*s)*(u*f-c*d);var e,t,n,i,r,o,a,s,l,u,c,g,h,d,f,v,p}},{key:"identity",value:function(){return this.copy(nn)}},{key:"fromQuaternion",value:function(e){return function(e,t){var n=t[0],i=t[1],r=t[2],o=t[3],a=n+n,s=i+i,l=r+r,u=n*a,c=i*a,g=i*s,h=r*a,d=r*s,f=r*l,v=o*a,p=o*s,m=o*l;e[0]=1-g-f,e[1]=c+m,e[2]=h-p,e[3]=0,e[4]=c-m,e[5]=1-u-f,e[6]=d+v,e[7]=0,e[8]=h+p,e[9]=d-v,e[10]=1-u-g,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(this,e),this.check()}},{key:"frustum",value:function(e){return function(e,t,n,i,r,o,a){var s=1/(n-t),l=1/(r-i),u=1/(o-a);e[0]=2*o*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=2*o*l,e[6]=0,e[7]=0,e[8]=(n+t)*s,e[9]=(r+i)*l,e[10]=(a+o)*u,e[11]=-1,e[12]=0,e[13]=0,e[14]=a*o*2*u,e[15]=0}(this,e.left,e.right,e.bottom,e.top,e.near,e.far),this.check()}},{key:"lookAt",value:function(e){var t=e.eye,n=e.center,i=void 0===n?[0,0,0]:n,r=e.up;return function(e,t,n,i){var r,o,a,s,l,u,c,g,h,d,f=t[0],v=t[1],p=t[2],m=i[0],y=i[1],x=i[2],S=n[0],b=n[1],C=n[2];Math.abs(f-S)<w&&Math.abs(v-b)<w&&Math.abs(p-C)<w?function(e){e[0]=1,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=1,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=1,e[11]=0,e[12]=0,e[13]=0,e[14]=0,e[15]=1}(e):(c=f-S,g=v-b,h=p-C,r=y*(h*=d=1/Math.sqrt(c*c+g*g+h*h))-x*(g*=d),o=x*(c*=d)-m*h,a=m*g-y*c,(d=Math.sqrt(r*r+o*o+a*a))?(r*=d=1/d,o*=d,a*=d):(r=0,o=0,a=0),s=g*a-h*o,l=h*r-c*a,u=c*o-g*r,(d=Math.sqrt(s*s+l*l+u*u))?(s*=d=1/d,l*=d,u*=d):(s=0,l=0,u=0),e[0]=r,e[1]=s,e[2]=c,e[3]=0,e[4]=o,e[5]=l,e[6]=g,e[7]=0,e[8]=a,e[9]=u,e[10]=h,e[11]=0,e[12]=-(r*f+o*v+a*p),e[13]=-(s*f+l*v+u*p),e[14]=-(c*f+g*v+h*p),e[15]=1)}(this,t,i,void 0===r?[0,1,0]:r),this.check()}},{key:"ortho",value:function(e){var t=e.left,n=e.right,i=e.bottom,r=e.top,o=e.near,a=void 0===o?.1:o,s=e.far;return function(e,t,n,i,r,o,a){var s=1/(t-n),l=1/(i-r),u=1/(o-a);e[0]=-2*s,e[1]=0,e[2]=0,e[3]=0,e[4]=0,e[5]=-2*l,e[6]=0,e[7]=0,e[8]=0,e[9]=0,e[10]=2*u,e[11]=0,e[12]=(t+n)*s,e[13]=(r+i)*l,e[14]=(a+o)*u,e[15]=1}(this,t,n,i,r,a,void 0===s?500:s),this.check()}},{key:"orthographic",value:function(e){var n=e.fovy,i=void 0===n?45*Math.PI/180:n,r=e.aspect,o=void 0===r?1:r,a=e.focalDistance,s=void 0===a?1:a,l=e.near,u=void 0===l?.1:l,c=e.far,g=void 0===c?500:c;if(i>2*Math.PI)throw Error("radians");var h=i/2,d=s*Math.tan(h),f=d*o;return(new t).ortho({left:-f,right:f,bottom:-d,top:d,near:u,far:g})}},{key:"perspective",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=e.fovy,n=e.fov,i=void 0===n?45*Math.PI/180:n,r=e.aspect,o=void 0===r?1:r,a=e.near,s=void 0===a?.1:a,l=e.far,u=void 0===l?500:l;if((t=t||i)>2*Math.PI)throw Error("radians");return B(this,t,o,s,u),this.check()}},{key:"transpose",value:function(){return function(e,t){if(e===t){var n=t[1],i=t[2],r=t[3],o=t[6],a=t[7],s=t[11];e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=n,e[6]=t[9],e[7]=t[13],e[8]=i,e[9]=o,e[11]=t[14],e[12]=r,e[13]=a,e[14]=s}else e[0]=t[0],e[1]=t[4],e[2]=t[8],e[3]=t[12],e[4]=t[1],e[5]=t[5],e[6]=t[9],e[7]=t[13],e[8]=t[2],e[9]=t[6],e[10]=t[10],e[11]=t[14],e[12]=t[3],e[13]=t[7],e[14]=t[11],e[15]=t[15]}(this,this),this.check()}},{key:"invert",value:function(){var e,t,n,i,r,o,a,s,l,u,c,g,h,d,f,v,p,m,y,x,S,b,C,M,w,E,P,k,A,T,D;return e=this,n=(t=this)[0],i=t[1],r=t[2],o=t[3],a=t[4],s=t[5],l=t[6],u=t[7],c=t[8],g=t[9],h=t[10],d=t[11],f=t[12],v=t[13],p=t[14],m=t[15],(D=(y=n*s-i*a)*(T=h*m-d*p)-(x=n*l-r*a)*(A=g*m-d*v)+(S=n*u-o*a)*(k=g*p-h*v)+(b=i*l-r*s)*(P=c*m-d*f)-(C=i*u-o*s)*(E=c*p-h*f)+(M=r*u-o*l)*(w=c*v-g*f))&&(D=1/D,e[0]=(s*T-l*A+u*k)*D,e[1]=(r*A-i*T-o*k)*D,e[2]=(v*M-p*C+m*b)*D,e[3]=(h*C-g*M-d*b)*D,e[4]=(l*P-a*T-u*E)*D,e[5]=(n*T-r*P+o*E)*D,e[6]=(p*S-f*M-m*x)*D,e[7]=(c*M-h*S+d*x)*D,e[8]=(a*A-s*P+u*w)*D,e[9]=(i*P-n*A-o*w)*D,e[10]=(f*C-v*S+m*y)*D,e[11]=(g*S-c*C-d*y)*D,e[12]=(s*E-a*k-l*w)*D,e[13]=(n*k-i*E+r*w)*D,e[14]=(v*x-f*b-p*y)*D,e[15]=(c*b-g*x+h*y)*D),this.check()}},{key:"multiplyLeft",value:function(e){return D(this,e,this),this.check()}},{key:"multiplyRight",value:function(e){return D(this,this,e),this.check()}},{key:"rotateX",value:function(e){return N(this,this,e),this.check()}},{key:"rotateY",value:function(e){var t,n,i,r,o,a,s,l,u,c,g,h,d;return t=this,n=this,i=e,r=Math.sin(i),o=Math.cos(i),a=n[0],s=n[1],l=n[2],u=n[3],c=n[8],g=n[9],h=n[10],d=n[11],n!==t&&(t[4]=n[4],t[5]=n[5],t[6]=n[6],t[7]=n[7],t[12]=n[12],t[13]=n[13],t[14]=n[14],t[15]=n[15]),t[0]=a*o-c*r,t[1]=s*o-g*r,t[2]=l*o-h*r,t[3]=u*o-d*r,t[8]=a*r+c*o,t[9]=s*r+g*o,t[10]=l*r+h*o,t[11]=u*r+d*o,this.check()}},{key:"rotateZ",value:function(e){return z(this,this,e),this.check()}},{key:"rotateXYZ",value:function(e){var t=M(e,3),n=t[0],i=t[1],r=t[2];return this.rotateX(n).rotateY(i).rotateZ(r)}},{key:"rotateAxis",value:function(e,t){return function(e,t,n,i){var r,o,a,s,l,u,c,g,h,d,f,v,p,m,y,x,S,b,C,M,E,P,k,A,T=i[0],D=i[1],_=i[2],O=Math.sqrt(T*T+D*D+_*_);O<w||(T*=O=1/O,D*=O,_*=O,r=Math.sin(n),a=1-(o=Math.cos(n)),s=t[0],l=t[1],u=t[2],c=t[3],g=t[4],h=t[5],d=t[6],f=t[7],v=t[8],p=t[9],m=t[10],y=t[11],x=T*T*a+o,S=D*T*a+_*r,b=_*T*a-D*r,C=T*D*a-_*r,M=D*D*a+o,E=_*D*a+T*r,P=T*_*a+D*r,k=D*_*a-T*r,A=_*_*a+o,e[0]=s*x+g*S+v*b,e[1]=l*x+h*S+p*b,e[2]=u*x+d*S+m*b,e[3]=c*x+f*S+y*b,e[4]=s*C+g*M+v*E,e[5]=l*C+h*M+p*E,e[6]=u*C+d*M+m*E,e[7]=c*C+f*M+y*E,e[8]=s*P+g*k+v*A,e[9]=l*P+h*k+p*A,e[10]=u*P+d*k+m*A,e[11]=c*P+f*k+y*A,t!==e&&(e[12]=t[12],e[13]=t[13],e[14]=t[14],e[15]=t[15]))}(this,this,e,t),this.check()}},{key:"scale",value:function(e){return Array.isArray(e)?O(this,this,e):O(this,this,[e,e,e]),this.check()}},{key:"translate",value:function(e){return _(this,this,e),this.check()}},{key:"transformVector2",value:function(e,t){return function(e,t,n){var i=t[0],r=t[1];e[0]=n[0]*i+n[4]*r+n[12],e[1]=n[1]*i+n[5]*r+n[13]}(t=t||new Jt,e,this),Zt(t,2),t}},{key:"transformVector3",value:function(e,t){return function(e,t,n){var i=t[0],r=t[1],o=t[2],a=n[3]*i+n[7]*r+n[11]*o+n[15];a=a||1,e[0]=(n[0]*i+n[4]*r+n[8]*o+n[12])/a,e[1]=(n[1]*i+n[5]*r+n[9]*o+n[13])/a,e[2]=(n[2]*i+n[6]*r+n[10]*o+n[14])/a}(t=t||new en,e,this),Zt(t,3),t}},{key:"transformVector4",value:function(e,t){return P(t=t||new tn,e,this),Zt(t,4),t.check()}},{key:"transformVector",value:function(e,t){switch(e.length){case 2:return this.transformVector2(e,t);case 3:return this.transformVector3(e,t);case 4:return this.transformVector4(e,t);default:throw new Error("Illegal vector")}}},{key:"transformDirection",value:function(e,t){return this._transformVector(e,t,0)}},{key:"transformPoint",value:function(e,t){return this._transformVector(e,t,1)}},{key:"_transformVector",value:function(e,t,n){switch(e.length){case 2:P(t=t||new Jt,[e[0],e[1],0,n],this),t.length=2,Zt(t,2);break;case 3:P(t=t||new en,[e[0],e[1],e[2],n],this),t.length=3,Zt(t,3);break;case 4:if(Boolean(n)!==Boolean(e[3]))throw new Error("math.gl: Matrix4.transformPoint - invalid vector");P(t=t||new tn,e,this),Zt(t,4);break;default:throw new Error("Illegal vector")}return t}},{key:"makeRotationX",value:function(e){return this.identity().rotateX(e)}},{key:"makeTranslation",value:function(e,t,n){return this.identity().translate([e,t,n])}},{key:"ELEMENTS",get:function(){return 16}}]),t}(),on=v.experimental.count,an=C.fp64.fp64LowPart,sn=6378e3;function ln(e){return Number.isFinite(e)?e:0}function un(e){var t=e.data,n=e.getPosition,i=e.cellSizeMeters,r=e.gpuGridAggregator,o=e.gpuAggregation,a=e.aggregationFlags,s=e.weightParams,l=e.fp64,u=void 0!==l&&l,c=e.coordinateSystem,g=void 0===c?v.COORDINATE_SYSTEM.LNGLAT:c,h=e.viewport,d=void 0===h?null:h,f=e.boundingBox,p=void 0===f?null:f,m={};a.dataChanged&&(p=(m=function(e,t,n){var i,r,o=on(e),a=new Float64Array(2*o),s=new Float32Array(2*o),l=1/0,u=-1/0,c=1/0,g=-1/0,h={};for(var d in n)h[d]=Object.assign({},n[d],{values:new Float32Array(3*o)});var f=Object(v.createIterable)(e),p=f.iterable,m=f.objectInfo,y=!0,x=!1,S=void 0;try{for(var b,C=p[Symbol.iterator]();!(y=(b=C.next()).done);y=!0){var M=b.value;m.index++;var w=t(M,m),E=m.index;for(var P in r=w[0],i=w[1],a[2*E]=r,a[2*E+1]=i,s[2*E]=an(r),s[2*E+1]=an(i),n){var k=n[P].getWeight(M);Array.isArray(k)?(h[P].values[3*E]=k[0],h[P].values[3*E+1]=k[1],h[P].values[3*E+2]=k[2]):h[P].values[3*E]=k}Number.isFinite(i)&&Number.isFinite(r)&&(l=i<l?i:l,u=i>u?i:u,c=r<c?r:c,g=r>g?r:g)}}catch(e){x=!0,S=e}finally{try{y||null==C.return||C.return()}finally{if(x)throw S}}var A={xMin:ln(c),xMax:ln(g),yMin:ln(l),yMax:ln(u)};return{positions:a,positions64xyLow:s,weights:h,boundingBox:A}}(t,n,s)).boundingBox);var y=[i,i],x=[0,0];switch(v.log.assert(g===v.COORDINATE_SYSTEM.LNGLAT||g===v.COORDINATE_SYSTEM.IDENTITY),g){case v.COORDINATE_SYSTEM.LNGLAT:case v.COORDINATE_SYSTEM.LNGLAT_DEPRECATED:var S=function(e,t){var n=e.yMin,i=e.yMax;return function(e,t){var n=(a=e,a/sn*(180/Math.PI)),i=(r=t,o=e,o/sn*(180/Math.PI)/Math.cos(r*Math.PI/180));var r,o;var a;return{yOffset:n,xOffset:i}}(t,(n+i)/2)}(p,i);y=[S.xOffset,S.yOffset],x=[-180,-90];break;case v.COORDINATE_SYSTEM.IDENTITY:x=[-d.width/2,-d.height/2];break;default:v.log.assert(!1)}var b=function(e){var t=e.boundingBox,n=e.cellSize,i=e.worldOrigin,r=t.yMin,o=t.yMax,a=t.xMin,s=t.xMax,l=cn(a-i[0],n[0])+i[0],u=cn(r-i[1],n[1])+i[1],c=(new rn).translate([-1*l,-1*u,0]),g=[l,u],h=s-a+n[0],d=o-r+n[1],f=[Math.ceil(h/n[0]),Math.ceil(d/n[1])];return{gridOrigin:g,gridSize:f,width:h,height:d,gridTransformMatrix:c}}({boundingBox:p,cellSize:y,worldOrigin:x});return{weights:r.run({positions:m.positions,positions64xyLow:m.positions64xyLow,weights:m.weights,cellSize:y,width:b.width,height:b.height,gridTransformMatrix:b.gridTransformMatrix,useGPU:o,changeFlags:a,fp64:u}),gridSize:b.gridSize,gridOrigin:b.gridOrigin,cellSize:y,boundingBox:p}}function cn(e,t){var n=e<0?-1:1,i=n<0?Math.abs(e)+t:Math.abs(e);return(i=Math.floor(i/t)*t)*n}var gn=[255,255,255,255],hn={cellSize:{type:"number",min:1,max:1e3,value:1e3},getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:function(e){return 1}},contours:[{threshold:1}],fp64:!1,zOffset:.005},dn=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"initializeState",value:function(){var e=this.context.gl,t={id:"".concat(this.id,"-gpu-aggregator"),shaderCache:this.context.shaderCache};this.state={contourData:{},gridAggregator:new le(e,t),colorTrigger:0,strokeWidthTrigger:0}}},{key:"updateState",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r=!1,o=!1,a=this._getAggregationFlags({oldProps:t,props:n,changeFlags:i});a&&(r=!0,this.setState({countsData:null}),this._aggregateData(a)),this._shouldRebuildContours({oldProps:t,props:n})&&(o=!0,this._updateThresholdData(n)),r||o?this._generateContours():this._updateSubLayerTriggers(t,n)}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this),this.state.gridAggregator.delete()}},{key:"renderLayers",value:function(){var e=this.state.contourData,t=e.contourSegments,n=e.contourPolygons,i=t&&t.length>0,r=n&&n.length>0;return[i&&new v.LineLayer(this._getLineLayerProps()),r&&new v.SolidPolygonLayer(this._getSolidPolygonLayerProps())]}},{key:"_aggregateData",value:function(e){var t=this.props,n=t.data,i=t.cellSize,r=t.getPosition,o=t.getWeight,a=t.gpuAggregation,s=t.fp64,l=t.coordinateSystem,u=un({data:n,cellSizeMeters:i,getPosition:r,weightParams:{count:{getWeight:o}},gpuAggregation:a,gpuGridAggregator:this.state.gridAggregator,fp64:s,coordinateSystem:l,viewport:this.context.viewport,boundingBox:this.state.boundingBox,aggregationFlags:e}),c=u.weights,g=u.gridSize,h=u.gridOrigin,d=u.cellSize,f=u.boundingBox;this.setState({countsData:c.count.aggregationData,countsBuffer:c.count.aggregationBuffer,gridSize:g,gridOrigin:h,cellSize:d,boundingBox:f})}},{key:"_generateContours",value:function(){var e=this.state,t=e.gridSize,n=e.gridOrigin,i=e.cellSize,r=e.thresholdData,o=this.state.countsData;o||(o=this.state.countsBuffer.getData(),this.setState({countsData:o}));var a=function(e){var t=e.thresholdData,n=(e.colors,e.cellWeights),i=e.gridSize,r=e.gridOrigin,o=e.cellSize,a=[],s=[],l=i[0],u=i[1];return t.forEach(function(e,t){for(var i=e.threshold,c=-1;c<l;c++)for(var g=-1;g<u;g++){var h=Bt({cellWeights:n,threshold:i,x:c,y:g,width:l,height:u}),d=h.code,f=h.meanCode,v={gridOrigin:r,cellSize:o,x:c,y:g,width:l,height:u,code:d,meanCode:f,thresholdData:e};if(Array.isArray(i))v.type=Ot.ISO_BANDS,Ft(v).forEach(function(e){s.push({vertices:e,threshold:i})});else{v.type=Ot.ISO_LINES;for(var p=Ft(v),m=0;m<p.length;m+=2)a.push({start:p[m],end:p[m+1],threshold:i})}}}),{contourSegments:a,contourPolygons:s}}({thresholdData:r,cellWeights:le.getCellData({countsData:o}).cellWeights,gridSize:t,gridOrigin:n,cellSize:i});this.setState({contourData:a})}},{key:"_getAggregationFlags",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r=null;return(i.dataChanged||t.gpuAggregation!==n.gpuAggregation||i.updateTriggersChanged&&(i.updateTriggersChanged.all||i.updateTriggersChanged.getPosition))&&(r=Object.assign({},r,{dataChanged:!0})),t.cellSize!==n.cellSize&&(r=Object.assign({},r,{cellSizeChanged:!0})),r}},{key:"_getLineLayerProps",value:function(){var e=this.state,t=e.colorTrigger,n=e.strokeWidthTrigger;return this.getSubLayerProps({id:"contour-line-layer",data:this.state.contourData.contourSegments,getSourcePosition:function(e){return e.start},getTargetPosition:function(e){return e.end},getColor:this._onGetSublayerColor.bind(this),getWidth:this._onGetSublayerStrokeWidth.bind(this),widthUnits:"pixels",updateTriggers:{getColor:t,getWidth:n}})}},{key:"_getSolidPolygonLayerProps",value:function(){var e=this.state.colorTrigger;return this.getSubLayerProps({id:"contour-solid-polygon-layer",data:this.state.contourData.contourPolygons,getPolygon:function(e){return e.vertices},getFillColor:this._onGetSublayerColor.bind(this),updateTriggers:{getFillColor:e}})}},{key:"_onGetSublayerColor",value:function(e){var t=this.props.contours,n=gn;return t.forEach(function(t){Ve(t.threshold,e.threshold)&&(n=t.color||gn)}),n}},{key:"_onGetSublayerStrokeWidth",value:function(e){var t=this.props.contours,n=1;return t.some(function(t){return t.threshold===e.threshold&&(n=t.strokeWidth||1,!0)}),n}},{key:"_shouldRebuildContours",value:function(e){var t=e.oldProps,n=e.props;if(!t.contours||!t.zOffset||t.contours.length!==n.contours.length||t.zOffset!==n.zOffset)return!0;var i=t.contours.map(function(e){return e.threshold}),r=n.contours.map(function(e){return e.threshold});return r.some(function(e,t){return!Ve(r[t],i[t])})}},{key:"_updateSubLayerTriggers",value:function(e,t){e&&e.contours&&t&&t.contours&&(t.contours.some(function(t,n){return t.color!==e.contours[n].color})&&this.state.colorTrigger++,t.contours.some(function(t,n){return t.strokeWidth!==e.contours[n].strokeWidth})&&this.state.strokeWidthTrigger++)}},{key:"_updateThresholdData",value:function(e){var t=e.contours.map(function(t,n){return{threshold:t.threshold,zIndex:t.zIndex||n,zOffset:e.zOffset}});this.setState({thresholdData:t})}}]),t}(v.CompositeLayer);dn.layerName="ContourLayer",dn.defaultProps=hn;var fn=new C.PhongMaterial,vn={colorDomain:null,colorRange:p,elevationDomain:null,elevationRange:[0,1e3],elevationScale:{type:"number",min:0,value:1},gridSize:{type:"array",min:0,value:[1,1]},gridOrigin:{type:"array",min:0,value:[0,0]},gridOffset:{type:"array",min:0,value:[0,0]},cellSize:{type:"number",min:0,max:1e3,value:1e3},offset:{type:"array",min:0,value:[1,1]},coverage:{type:"number",min:0,max:1,value:1},extruded:!0,material:fn},pn=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"getShaders",value:function(){return h()(c()(t.prototype),"getShaders",this).call(this,{vs:"#version 300 es\n#define SHADER_NAME gpu-grid-cell-layer-vertex-shader\n#define RANGE_COUNT 6\n\nin vec3 positions;\nin vec3 normals;\n\nin vec4 colors;\nin vec4 elevations;\nin vec3 instancePickingColors;\nuniform vec2 offset;\nuniform bool extruded;\nuniform float cellSize;\nuniform float coverage;\nuniform float opacity;\nuniform float elevationScale;\n\nuniform ivec2 gridSize;\nuniform vec2 gridOrigin;\nuniform vec2 gridOriginLow;\nuniform vec2 gridOffset;\nuniform vec2 gridOffsetLow;\nuniform vec4 colorRange[RANGE_COUNT];\nuniform vec2 elevationRange;\nuniform vec2 colorDomain;\nuniform bool colorDomainValid;\nuniform vec2 elevationDomain;\nuniform bool elevationDomainValid;\n\nlayout(std140) uniform;\nuniform ColorData\n{\n  vec4 maxMinCount;\n} colorData;\nuniform ElevationData\n{\n  vec4 maxMinCount;\n} elevationData;\n\n#define EPSILON 0.00001\nout vec4 vColor;\n\nvec4 quantizeScale(vec2 domain, vec4 range[RANGE_COUNT], float value) {\n  vec4 outColor = vec4(0., 0., 0., 0.);\n  if (value >= (domain.x - EPSILON) && value <= (domain.y + EPSILON)) {\n    float domainRange = domain.y - domain.x;\n    if (domainRange <= 0.) {\n      outColor = colorRange[0];\n    } else {\n      float rangeCount = float(RANGE_COUNT);\n      float rangeStep = domainRange / rangeCount;\n      float idx = floor((value - domain.x) / rangeStep);\n      idx = clamp(idx, 0., rangeCount - 1.);\n      int intIdx = int(idx);\n      outColor = colorRange[intIdx];\n    }\n  }\n  return outColor;\n}\n\nfloat linearScale(vec2 domain, vec2 range, float value) {\n  if (value >= (domain.x - EPSILON) && value <= (domain.y + EPSILON)) {\n    return ((value - domain.x) / (domain.y - domain.x)) * (range.y - range.x) + range.x;\n  }\n  return -1.;\n}\n\nvoid main(void) {\n\n  vec2 clrDomain = colorDomainValid ? colorDomain : vec2(colorData.maxMinCount.a, colorData.maxMinCount.r);\n  vec4 color = quantizeScale(clrDomain, colorRange, colors.r);\n\n  float elevation = 0.0;\n\n  if (extruded) {\n    vec2 elvDomain = elevationDomainValid ? elevationDomain : vec2(elevationData.maxMinCount.a, elevationData.maxMinCount.r);\n    elevation = linearScale(elvDomain, elevationRange, elevations.r);\n    elevation = elevation  * (positions.z + 1.0) / 2.0 * elevationScale;\n  }\n  float shouldRender = float(color.r > 0.0 && elevations.r >= 0.0);\n  float dotRadius = cellSize / 2. * coverage * shouldRender;\n\n  int yIndex = (gl_InstanceID / gridSize[0]);\n  int xIndex = gl_InstanceID - (yIndex * gridSize[0]);\n\n  vec2 instancePositionXFP64 = mul_fp64(vec2(gridOffset[0], gridOffsetLow[0]), vec2(float(xIndex), 0.));\n  instancePositionXFP64 = sum_fp64(instancePositionXFP64, vec2(gridOrigin[0], gridOriginLow[0]));\n  vec2 instancePositionYFP64 = mul_fp64(vec2(gridOffset[1], gridOffsetLow[1]), vec2(float(yIndex), 0.));\n  instancePositionYFP64 = sum_fp64(instancePositionYFP64, vec2(gridOrigin[1], gridOriginLow[1]));\n\n  vec3 centroidPosition = vec3(instancePositionXFP64[0], instancePositionYFP64[0], elevation);\n  vec2 centroidPosition64xyLow = vec2(instancePositionXFP64[1], instancePositionYFP64[1]);\n  vec3 pos = vec3(project_size(positions.xy + offset) * dotRadius, 0.);\n  picking_setPickingColor(instancePickingColors);\n\n  vec4 position_commonspace;\n  gl_Position = project_position_to_clipspace(centroidPosition, centroidPosition64xyLow, pos, position_commonspace);\n\n  vec3 normals_commonspace = project_normal(normals);\n\n   if (extruded) {\n    vec3 lightColor = lighting_getLightColor(color.rgb, project_uCameraPosition, position_commonspace.xyz, normals_commonspace);\n    vColor = vec4(lightColor, color.a * opacity) / 255.;\n  } else {\n    vColor = vec4(color.rgb, color.a * opacity) / 255.;\n  }\n}\n",fs:"#version 300 es\n#define SHADER_NAME gpu-grid-cell-layer-fragment-shader\n\nprecision highp float;\n\nin vec4 vColor;\n\nout vec4 fragColor;\n\nvoid main(void) {\n  fragColor = vColor;\n  fragColor = picking_filterColor(fragColor);\n}\n",modules:["project32","gouraud-lighting","picking",C.fp64]})}},{key:"initializeState",value:function(){var e=this.context.gl;this.getAttributeManager().addInstanced({colors:{size:4,update:this.calculateColors,noAlloc:!0},elevations:{size:4,update:this.calculateElevations,noAlloc:!0}});var t=this._getModel(e);this._setupUniformBuffer(t),this.setState({model:t})}},{key:"_getModel",value:function(e){return new C.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new C.CubeGeometry,isInstanced:!0,shaderCache:this.context.shaderCache}))}},{key:"draw",value:function(e){var t=e.uniforms,n=this.props,i=n.data,r=n.cellSize,o=n.offset,a=n.extruded,s=n.elevationScale,l=n.coverage,u=n.gridSize,c=n.gridOrigin,g=n.gridOffset,h=n.elevationRange,d=[Object(v.fp64LowPart)(c[0]),Object(v.fp64LowPart)(c[1])],f=[Object(v.fp64LowPart)(g[0]),Object(v.fp64LowPart)(g[1])],p=this.getDomainUniforms(),y={colorMaxMinBuffer:i.color.maxMinBuffer,elevationMaxMinBuffer:i.elevation.maxMinBuffer},x=m(this.props.colorRange);this.bindUniformBuffers(y),this.state.model.setUniforms(Object.assign({},t,p,{cellSize:r,offset:o,extruded:a,elevationScale:s,coverage:l,gridSize:u,gridOrigin:c,gridOriginLow:d,gridOffset:g,gridOffsetLow:f,colorRange:x,elevationRange:h})).draw(),this.unbindUniformBuffers(y)}},{key:"bindUniformBuffers",value:function(e){var t=e.colorMaxMinBuffer,n=e.elevationMaxMinBuffer;t.bind({target:35345,index:0}),n.bind({target:35345,index:1})}},{key:"unbindUniformBuffers",value:function(e){var t=e.colorMaxMinBuffer,n=e.elevationMaxMinBuffer;t.unbind({target:35345,index:0}),n.unbind({target:35345,index:1})}},{key:"calculateColors",value:function(e){var t=this.props.data;e.update({buffer:t.color.aggregationBuffer})}},{key:"calculateElevations",value:function(e){var t=this.props.data;e.update({buffer:t.elevation.aggregationBuffer})}},{key:"getDomainUniforms",value:function(){var e=this.props,t=e.colorDomain,n=e.elevationDomain,i={};return null!==t?(i.colorDomainValid=!0,i.colorDomain=t):i.colorDomainValid=!1,null!==n?(i.elevationDomainValid=!0,i.elevationDomain=n):i.elevationDomainValid=!1,i}},{key:"_setupUniformBuffer",value:function(e){var t=this.context.gl,n=e.program.handle,i=t.getUniformBlockIndex(n,"ColorData"),r=t.getUniformBlockIndex(n,"ElevationData");t.uniformBlockBinding(n,i,0),t.uniformBlockBinding(n,r,1)}}]),t}(v.Layer);pn.layerName="GPUGridCellLayer",pn.defaultProps=vn;var mn={colorDomain:null,colorRange:p,getColorWeight:{type:"accessor",value:function(e){return 1}},colorAggregation:"SUM",elevationDomain:null,elevationRange:[0,1e3],getElevationWeight:{type:"accessor",value:function(e){return 1}},elevationAggregation:"SUM",elevationScale:{type:"number",min:0,value:1},cellSize:{type:"number",min:0,max:1e3,value:1e3},coverage:{type:"number",min:0,max:1,value:1},getPosition:{type:"accessor",value:function(e){return e.position}},extruded:!1,fp64:!1,material:new C.PhongMaterial,gpuAggregation:!0},yn=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"initializeState",value:function(){var e=this.context.gl,t=le.isSupported(e);t||v.log.error("GPUGridLayer is not supported on this browser, use GridLayer instead")();var n={id:"".concat(this.id,"-gpu-aggregator"),shaderCache:this.context.shaderCache};this.state={gpuGridAggregator:new le(e,n),isSupported:t}}},{key:"updateState",value:function(e){var t=this.getAggregationFlags(e);t&&(this.getLayerData(t),this.setState({gridHash:null}))}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this),this.state.gpuGridAggregator.delete()}},{key:"getAggregationFlags",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags,r=null;return!!this.state.isSupported&&(this.isDataChanged({oldProps:t,props:n,changeFlags:i})&&(r=Object.assign({},r,{dataChanged:!0})),t.cellSize!==n.cellSize&&(r=Object.assign({},r,{cellSizeChanged:!0})),r)}},{key:"isDataChanged",value:function(e){var t=e.oldProps,n=e.props,i=e.changeFlags;return!!i.dataChanged||(t.gpuAggregation!==n.gpuAggregation||(t.colorAggregation!==n.colorAggregation||t.elevationAggregation!==n.elevationAggregation||!(!i.updateTriggersChanged||!(i.updateTriggersChanged.all||i.updateTriggersChanged.getPosition||i.updateTriggersChanged.getColorWeight||i.updateTriggersChanged.getElevationWeight))))}},{key:"getHashKeyForIndex",value:function(e){var t=this.state,n=t.gridSize,i=t.gridOrigin,r=t.cellSize,o=Math.floor(e/n[0]),a=e-o*n[0],s=Math.floor((o*r[1]+i[1]+90+r[1]/2)/r[1]),l=Math.floor((a*r[0]+i[0]+180+r[0]/2)/r[0]);return"".concat(s,"-").concat(l)}},{key:"getPositionForIndex",value:function(e){var t=this.state,n=t.gridSize,i=t.gridOrigin,r=t.cellSize,o=Math.floor(e/n[0]),a=e-o*n[0],s=o*r[1]+i[1];return[a*r[0]+i[0],s]}},{key:"getPickingInfo",value:function(e){var t=e.info,n=e.mode,i=t.index,r=null;if(i>=0){var o=this.state.gpuGridAggregator,a=this.getPositionForIndex(i),s=le.getAggregationData(Object.assign({pixelIndex:i},o.getData("color"))),l=le.getAggregationData(Object.assign({pixelIndex:i},o.getData("elevation")));if(r={colorValue:s.cellWeight,elevationValue:l.cellWeight,count:s.cellCount||l.cellCount,position:a,totalCount:s.totalCount||l.totalCount},"hover"!==n){var u=this.props,c=u.data,g=u.getPosition,h=this.state.gridHash;if(!h)h=be(c,this.props.cellSize,g).gridHash,this.setState({gridHash:h});var d=h[this.getHashKeyForIndex(i)];Object.assign(r,d)}}return Object.assign(t,{picked:Boolean(r),object:r})}},{key:"getLayerData",value:function(e){var t=this.props,n=t.data,i=t.cellSize,r=t.getPosition,o=t.gpuAggregation,a=t.getColorWeight,s=t.colorAggregation,l=t.getElevationWeight,u=t.elevationAggregation,c=t.fp64,g=un({data:n,cellSizeMeters:i,getPosition:r,weightParams:{color:{getWeight:a,operation:I[s]||I[mn.colorAggregation],needMin:!0,needMax:!0,combineMaxMin:!0},elevation:{getWeight:l,operation:I[u]||I[mn.elevationAggregation],needMin:!0,needMax:!0,combineMaxMin:!0}},gpuAggregation:o,gpuGridAggregator:this.state.gpuGridAggregator,boundingBox:this.state.boundingBox,aggregationFlags:e,fp64:c}),h=g.weights,d=g.gridSize,f=g.gridOrigin,v=g.cellSize,p=g.boundingBox;this.setState({weights:h,gridSize:d,gridOrigin:f,cellSize:v,boundingBox:p})}},{key:"renderLayers",value:function(){if(!this.state.isSupported)return null;var e=this.props,t=e.elevationScale,n=e.extruded,i=e.cellSize,r=e.coverage,o=e.material,a=e.elevationRange,s=e.colorDomain,l=e.elevationDomain,u=this.state,c=u.weights,g=u.gridSize,h=u.gridOrigin,d=u.cellSize,f=m(this.props.colorRange);return new(this.getSubLayerClass("gpu-grid-cell",pn))({gridSize:g,gridOrigin:h,gridOffset:d,colorRange:f,elevationRange:a,colorDomain:s,elevationDomain:l,cellSize:i,coverage:r,material:o,elevationScale:t,extruded:n},this.getSubLayerProps({id:"gpu-grid-cell"}),{data:c,numInstances:g[0]*g[1]})}}]),t}(v.CompositeLayer);yn.layerName="GPUGridLayer",yn.defaultProps=mn;var xn=Object.assign({},yn.defaultProps,Pe.defaultProps,{gpuAggregation:!1}),Sn=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"initializeState",value:function(){this.state={useGPUAggregation:!0}}},{key:"updateState",value:function(e){e.oldProps;var t=e.props,n=(e.changeFlags,{});n.useGPUAggregation=this.canUseGPUAggregation(t),this.setState(n)}},{key:"renderLayers",value:function(){var e=this.props,t=e.data,n=e.updateTriggers,i=this.state.useGPUAggregation?"GPU":"CPU";return new(this.state.useGPUAggregation?this.getSubLayerClass("GPU",yn):this.getSubLayerClass("CPU",Pe))(this.props,this.getSubLayerProps({id:i,updateTriggers:n}),{data:t})}},{key:"canUseGPUAggregation",value:function(e){var t=e.gpuAggregation,n=e.lowerPercentile,i=e.upperPercentile,r=e.getColorValue,o=e.getElevationValue;return!!t&&(!!le.isSupported(this.context.gl)&&(0===n&&100===i&&(null===r&&null===o)))}}]),t}(v.CompositeLayer);Sn.layerName="GridLayer",Sn.defaultProps=xn;var bn=new Float32Array(12);function Cn(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2,n=0,i=!0,r=!1,o=void 0;try{for(var a,s=e[Symbol.iterator]();!(i=(a=s.next()).done);i=!0)for(var l=a.value,u=0;u<t;u++)bn[n++]=l[u]||0}catch(e){r=!0,o=e}finally{try{i||null==s.return||s.return()}finally{if(r)throw o}}return bn}function Mn(e,t,n){var i=b()(e,4),r=i[0],o=i[1],a=i[2],s=i[3],l=a-r,u=s-o,c=l,g=u;l/u<t/n?c=t/n*u:g=n/t*l,c<t&&(c=t,g=n);var h=(a+r)/2,d=(s+o)/2;return[h-c/2,d-g/2,h+c/2,d+g/2]}var wn=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"getShaders",value:function(){return{vs:"#define SHADER_NAME heatp-map-layer-vertex-shader\n\nuniform sampler2D maxTexture;\nuniform float intensity;\n\nattribute vec3 positions;\nattribute vec2 texCoords;\n\nvarying vec2 vTexCoords;\nvarying float vIntensity;\n\nvoid main(void) {\n  gl_Position = project_position_to_clipspace(positions, vec2(0.0), vec3(0.0));\n  vTexCoords = texCoords;\n  float maxValue = texture2D(maxTexture, vec2(0.5)).r;\n  vIntensity = intensity / maxValue;\n}\n",fs:"#define SHADER_NAME triangle-layer-fragment-shader\n\nprecision highp float;\n\nuniform float opacity;\nuniform sampler2D texture;\nvarying vec2 vTexCoords;\nuniform sampler2D colorTexture;\nuniform float threshold;\n\nvarying float vIntensity;\n\nvec4 getLinearColor(float value) {\n  float factor = clamp(value, 0., 1.);\n  vec4 color = texture2D(colorTexture, vec2(factor, 0.5));\n  color.a *= min(value / threshold, 1.0);\n  return color;\n}\n\nvoid main(void) {\n  float weight = texture2D(texture, vTexCoords).r;\n  if (weight == 0.) {\n     discard;\n  }\n  vec4 linearColor = getLinearColor(weight * vIntensity);\n  linearColor.a *= opacity;\n  gl_FragColor =linearColor;\n}\n",modules:["project32"]}}},{key:"initializeState",value:function(){var e=this.context.gl;this.getAttributeManager().add({positions:{size:3,noAlloc:!0},texCoords:{size:2,noAlloc:!0}}),this.setState({model:this._getModel(e)})}},{key:"_getModel",value:function(e){var t=this.props.vertexCount;return new C.Model(e,Object.assign({},this.getShaders(),{id:this.props.id,geometry:new C.Geometry({drawMode:6,vertexCount:t}),shaderCache:this.context.shaderCache}))}},{key:"draw",value:function(e){e.uniforms;var t=this.state.model,n=this.props,i=n.texture,r=n.maxTexture,o=n.colorTexture,a=n.intensity,s=n.threshold;t.setUniforms({texture:i,maxTexture:r,colorTexture:o,intensity:a,threshold:s}).draw()}}]),t}(v.Layer);wn.layerName="TriangleLayer",wn.defaultProps={count:0,texture:null};var En,Pn=(En={},x()(En,10240,9729),x()(En,10241,9729),x()(En,10242,33071),x()(En,10243,33071),En),kn={getPosition:{type:"accessor",value:function(e){return e.position}},getWeight:{type:"accessor",value:1},intensity:{type:"number",min:0,value:1},radiusPixels:{type:"number",min:1,max:100,value:30},colorRange:p,threshold:{type:"number",min:0,max:1,value:.05}},An=function(e){function t(){return r()(this,t),l()(this,c()(t).apply(this,arguments))}return f()(t,e),a()(t,[{key:"initializeState",value:function(){var e=this.context.gl,t=Math.min(2048,Object(C.getParameter)(e,3379));if(this.state={textureSize:t,supported:!0},!Object(C.isWebGL2)(e))return v.log.error("HeatmapLayer ".concat(this.id," is not supported on this browser, requires WebGL2"))(),void this.setState({supported:!1});this._setupAttributes(),this._setupResources()}},{key:"shouldUpdateState",value:function(e){return e.changeFlags.somethingChanged}},{key:"updateState",value:function(e){if(this.state.supported){h()(c()(t.prototype),"updateState",this).call(this,e);var n=e.props,i=e.oldProps,r=this._getChangeFlags(e);r.viewportChanged&&(r.boundsChanged=this._updateBounds()),r.dataChanged||r.boundsChanged||r.uniformsChanged?this._updateWeightmap():r.viewportZoomChanged&&this._debouncedUpdateWeightmap(),n.colorRange!==i.colorRange&&this._updateColorTexture(e),r.viewportChanged&&this._updateTextureRenderingBounds(),this.setState({zoom:e.context.viewport.zoom})}}},{key:"renderLayers",value:function(){if(!this.state.supported)return[];var e=this.state,t=e.weightsTexture,n=e.triPositionBuffer,i=e.triTexCoordBuffer,r=e.maxWeightsTexture,o=e.colorTexture,a=this.props,s=a.updateTriggers,l=a.intensity,u=a.threshold;return new wn(this.getSubLayerProps({id:"".concat(this.id,"-triangle-layer"),updateTriggers:s}),{id:"heatmap-triangle-layer",data:{attributes:{positions:n,texCoords:i}},vertexCount:4,maxTexture:r,colorTexture:o,texture:t,intensity:l,threshold:u})}},{key:"finalizeState",value:function(){h()(c()(t.prototype),"finalizeState",this).call(this);var e=this.state,n=e.weightsTransform,i=e.weightsTexture,r=e.maxWeightTransform,o=e.maxWeightsTexture,a=e.triPositionBuffer,s=e.triTexCoordBuffer,l=e.colorTexture;n&&n.delete(),i&&i.delete(),r&&r.delete(),o&&o.delete(),a&&a.delete(),s&&s.delete(),l&&l.delete()}},{key:"_getAttributeManager",value:function(){return new v.AttributeManager(this.context.gl,{id:this.props.id,stats:this.context.stats})}},{key:"_getChangeFlags",value:function(e){var t=e.oldProps,n=e.props,i={};this._isDataChanged(e)&&(i.dataChanged=!0),t.radiusPixels!==n.radiusPixels&&(i.uniformsChanged=!0),i.viewportChanged=e.changeFlags.viewportChanged;var r=this.state.zoom;return e.context.viewport&&e.context.viewport.zoom===r||(i.viewportZoomChanged=!0),i}},{key:"_isDataChanged",value:function(e){var t=e.changeFlags;return!!t.dataChanged||!(!t.updateTriggersChanged||!(t.updateTriggersChanged.all||t.updateTriggersChanged.getPosition||t.updateTriggersChanged.getWeight))}},{key:"_setupAttributes",value:function(){this.getAttributeManager().add({positions:{size:3,accessor:"getPosition"},weights:{size:1,accessor:"getWeight"}})}},{key:"_setupResources",value:function(){var e=this.context.gl,t=this.state.textureSize,n=ne(e,{width:t,height:t,parameters:Pn}),i=ne(e),r=new C.Transform(e,{id:"".concat(this.id,"-weights-transform"),vs:"attribute vec3 positions;\nattribute float weights;\nvarying vec4 weightsTexture;\nuniform float radiusPixels;\nuniform float textureWidth;\nuniform vec4 commonBounds;\nvoid main()\n{\n  weightsTexture = vec4(weights, 0., 0., 1.);\n\n  float radiusTexels  = radiusPixels * textureWidth / (commonBounds.z - commonBounds.x);\n  gl_PointSize = radiusTexels * 2.;\n\n  vec3 commonPosition = project_position(positions, vec2(0));\n  gl_Position.xy = (commonPosition.xy - commonBounds.xy) / (commonBounds.zw - commonBounds.xy) ;\n  gl_Position.xy = (gl_Position.xy * 2.) - (1.);\n}\n",_fs:"varying vec4 weightsTexture;\nfloat gaussianKDE(float u){\n  return pow(2.71828, -u*u/0.05555)/(1.77245385*0.166666);\n}\nvoid main()\n{\n  float dist = length(gl_PointCoord - vec2(0.5, 0.5));\n  if (dist > 0.5) {\n    discard;\n  }\n  gl_FragColor.rgb = weightsTexture.rgb * gaussianKDE(2. * dist);\n  gl_FragColor.a = 1.0;\n}\n",modules:["project32"],elementCount:1,_targetTexture:n,_targetTextureVarying:"weightsTexture"});this.setState({weightsTexture:n,maxWeightsTexture:i,weightsTransform:r,model:r.model,maxWeightTransform:new C.Transform(e,{id:"".concat(this.id,"-max-weights-transform"),_sourceTextures:{inTexture:n},_targetTexture:i,_targetTextureVarying:"outTexture",vs:"#version 300 es\nin vec4 inTexture;\nout vec4 outTexture;\n\nvoid main()\n{\noutTexture = inTexture;\ngl_Position = vec4(0, 0, 0, 1.);\n}\n",elementCount:t*t}),zoom:null,triPositionBuffer:new C.Buffer(e,{byteLength:48,accessor:{size:3}}),triTexCoordBuffer:new C.Buffer(e,{byteLength:48,accessor:{size:2}})})}},{key:"_updateMaxWeightValue",value:function(){this.state.maxWeightTransform.run({parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32776}})}},{key:"_updateBounds",value:function(){var e,t,n,i,r,o,a,s=arguments.length>0&&void 0!==arguments[0]&&arguments[0],l=this.state.textureSize,u=this.context.viewport,c=[u.unproject([0,0]),u.unproject([u.width,0]),u.unproject([u.width,u.height]),u.unproject([0,u.height])],g=(t=(e=c).map(function(e){return e[0]}),n=e.map(function(e){return e[1]}),i=Math.min.apply(null,t),r=Math.max.apply(null,t),[i,Math.min.apply(null,n),r,Math.max.apply(null,n)]),h=this._worldToCommonBounds(g),d={visibleWorldBounds:g,viewportCorners:c},f=!1;if(s||!this.state.worldBounds||(o=this.state.worldBounds,!((a=g)[0]>=o[0]&&a[2]<=o[2]&&a[1]>=o[1]&&a[3]<=o[3]))){var p=Mn(h,2*l,2*l),m=this._commonToWorldBounds(p);this.props.coordinateSystem===v.COORDINATE_SYSTEM.LNGLAT&&(m[1]=Math.max(m[1],-85.051129),m[3]=Math.min(m[3],85.051129),m[0]=Math.max(m[0],-360),m[2]=Math.min(m[2],360));var y=this._worldToCommonBounds(m,{scaleToAspect:!0,normalize:!0,width:2*l,height:2*l});d.worldBounds=m,d.normalizedCommonBounds=y,f=!0}return this.setState(d),f}},{key:"_updateTextureRenderingBounds",value:function(){var e=this.state,t=e.triPositionBuffer,n=e.triTexCoordBuffer,i=e.normalizedCommonBounds,r=e.viewportCorners,o=this.context.viewport,a=i.map(function(e){return e*o.scale});t.subData(Cn(r,3));var s=r.map(function(e){return t=o.projectPosition(e),n=a,i=b()(n,4),r=i[0],s=i[1],l=i[2],u=i[3],[(t[0]-r)/(l-r),(t[1]-s)/(u-s)];var t,n,i,r,s,l,u});n.subData(Cn(s,2))}},{key:"_updateColorTexture",value:function(e){var t=e.props.colorRange,n=this.state.colorTexture,i=m(t,!0);n?n.setImageData({data:i,width:t.length}):n=ne(this.context.gl,{data:i,width:t.length,parameters:Pn}),this.setState({colorTexture:n})}},{key:"_updateWeightmap",value:function(){var e=this.props.radiusPixels,t=this.state,n=t.weightsTransform,i=t.worldBounds,r=t.textureSize;this._updateAttributes(this.props);var o=Object.assign(Object.create(this.props),{viewport:this.context.viewport,pickingActive:0}),a=this._worldToCommonBounds(i,{useLayerCoordinateSystem:!0,scaleToAspect:!0,width:2*r,height:2*r}),s=Object.assign({},n.model.getModuleUniforms(o),{radiusPixels:e,commonBounds:a,textureWidth:r});n.update({elementCount:this.getNumInstances()}),n.run({uniforms:s,parameters:{blend:!0,depthTest:!1,blendFunc:[1,1],blendEquation:32774},clearRenderTarget:!0}),this._updateMaxWeightValue(),this.setState({lastUpdate:Date.now()})}},{key:"_debouncedUpdateWeightmap",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.state.updateTimer,n=Date.now()-this.state.lastUpdate;e&&(t=null),n>=500?(this._updateBounds(!0),this._updateWeightmap(),this._updateTextureRenderingBounds()):t||(t=setTimeout(this._debouncedUpdateWeightmap.bind(this,!0),500-n)),this.setState({updateTimer:t})}},{key:"_worldToCommonBounds",value:function(e){var t,n,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=i.useLayerCoordinateSystem,o=void 0!==r&&r,a=i.scaleToAspect,s=void 0!==a&&a,l=i.width,u=i.height,c=b()(e,4),g=c[0],h=c[1],d=c[2],f=c[3],v=this.context.viewport;o?(t=this.projectPosition([g,f,0]),n=this.projectPosition([d,h,0])):(t=v.projectPosition([g,f,0]),n=v.projectPosition([d,h,0]));var p=t.slice(0,2).concat(n.slice(0,2));return s&&(p=Mn(p,l,u)),i.normalize&&(p=p.map(function(e){return e/v.scale})),p}},{key:"_commonToWorldBounds",value:function(e){var t=b()(e,4),n=t[0],i=t[1],r=t[2],o=t[3],a=this.context.viewport,s=a.unprojectPosition([n,o]),l=a.unprojectPosition([r,i]);return s.slice(0,2).concat(l.slice(0,2))}}]),t}(v.CompositeLayer);An.layerName="HeatmapLayer",An.defaultProps=kn,n.d(t,"experimental",function(){return Tn}),n.d(t,"ScreenGridLayer",function(){return fe}),n.d(t,"CPUGridLayer",function(){return Pe}),n.d(t,"HexagonLayer",function(){return Fe}),n.d(t,"ContourLayer",function(){return dn}),n.d(t,"GridLayer",function(){return Sn}),n.d(t,"GPUGridLayer",function(){return yn}),n.d(t,"AGGREGATION_OPERATION",function(){return I}),n.d(t,"HeatmapLayer",function(){return An}),n.d(t,"_GPUGridAggregator",function(){return le});var Tn={BinSorter:pe,linearScale:function(e,t,n){return(n-e[0])/(e[1]-e[0])*(t[1]-t[0])+t[0]},getLinearScale:xe,quantizeScale:me,getQuantizeScale:ye,defaultColorRange:p}}])});