{"version":3,"sources":["../../../src/animation/timeline.js"],"names":["channelHandles","animationHandles","Timeline","constructor","time","channels","Map","animations","playing","lastEngineTime","addChannel","props","delay","duration","Number","POSITIVE_INFINITY","rate","repeat","handle","channel","_setChannelTime","set","removeChannel","delete","animationHandle","animation","detachAnimation","getTime","undefined","get","setTime","Math","max","values","animationData","play","pause","reset","attachAnimation","channelHandle","update","engineTime","offsetTime","totalDuration"],"mappings":"AAAA,IAAIA,cAAc,GAAG,CAArB;AACA,IAAIC,gBAAgB,GAAG,CAAvB;AAEA,OAAO,MAAMC,QAAN,CAAe;AACpBC,EAAAA,WAAW,GAAG;AACZ,SAAKC,IAAL,GAAY,CAAZ;AACA,SAAKC,QAAL,GAAgB,IAAIC,GAAJ,EAAhB;AACA,SAAKC,UAAL,GAAkB,IAAID,GAAJ,EAAlB;AACA,SAAKE,OAAL,GAAe,KAAf;AACA,SAAKC,cAAL,GAAsB,CAAC,CAAvB;AACD;;AAEDC,EAAAA,UAAU,CAACC,KAAD,EAAQ;AAChB,UAAM;AAACC,MAAAA,KAAK,GAAG,CAAT;AAAYC,MAAAA,QAAQ,GAAGC,MAAM,CAACC,iBAA9B;AAAiDC,MAAAA,IAAI,GAAG,CAAxD;AAA2DC,MAAAA,MAAM,GAAG;AAApE,QAAyEN,KAA/E;AAEA,UAAMO,MAAM,GAAGlB,cAAc,EAA7B;AACA,UAAMmB,OAAO,GAAG;AACdf,MAAAA,IAAI,EAAE,CADQ;AAEdQ,MAAAA,KAFc;AAGdC,MAAAA,QAHc;AAIdG,MAAAA,IAJc;AAKdC,MAAAA;AALc,KAAhB;;AAOA,SAAKG,eAAL,CAAqBD,OAArB,EAA8B,KAAKf,IAAnC;;AACA,SAAKC,QAAL,CAAcgB,GAAd,CAAkBH,MAAlB,EAA0BC,OAA1B;AAEA,WAAOD,MAAP;AACD;;AAEDI,EAAAA,aAAa,CAACJ,MAAD,EAAS;AACpB,SAAKb,QAAL,CAAckB,MAAd,CAAqBL,MAArB;;AAEA,SAAK,MAAM,CAACM,eAAD,EAAkBC,SAAlB,CAAX,IAA2C,KAAKlB,UAAhD,EAA4D;AAC1D,UAAIkB,SAAS,CAACN,OAAV,KAAsBD,MAA1B,EAAkC;AAChC,aAAKQ,eAAL,CAAqBF,eAArB;AACD;AACF;AACF;;AAEDG,EAAAA,OAAO,CAACT,MAAD,EAAS;AACd,QAAIA,MAAM,KAAKU,SAAf,EAA0B;AACxB,aAAO,KAAKxB,IAAZ;AACD;;AAED,UAAMe,OAAO,GAAG,KAAKd,QAAL,CAAcwB,GAAd,CAAkBX,MAAlB,CAAhB;;AAEA,QAAIC,OAAO,KAAKS,SAAhB,EAA2B;AACzB,aAAO,CAAC,CAAR;AACD;;AAED,WAAOT,OAAO,CAACf,IAAf;AACD;;AAED0B,EAAAA,OAAO,CAAC1B,IAAD,EAAO;AACZ,SAAKA,IAAL,GAAY2B,IAAI,CAACC,GAAL,CAAS,CAAT,EAAY5B,IAAZ,CAAZ;AAEA,UAAMC,QAAQ,GAAG,KAAKA,QAAL,CAAc4B,MAAd,EAAjB;;AACA,SAAK,MAAMd,OAAX,IAAsBd,QAAtB,EAAgC;AAC9B,WAAKe,eAAL,CAAqBD,OAArB,EAA8B,KAAKf,IAAnC;AACD;;AAED,UAAMG,UAAU,GAAG,KAAKA,UAAL,CAAgB0B,MAAhB,EAAnB;;AACA,SAAK,MAAMC,aAAX,IAA4B3B,UAA5B,EAAwC;AACtC,YAAM;AAACkB,QAAAA,SAAD;AAAYN,QAAAA;AAAZ,UAAuBe,aAA7B;AACAT,MAAAA,SAAS,CAACK,OAAV,CAAkB,KAAKH,OAAL,CAAaR,OAAb,CAAlB;AACD;AACF;;AAEDgB,EAAAA,IAAI,GAAG;AACL,SAAK3B,OAAL,GAAe,IAAf;AACD;;AAED4B,EAAAA,KAAK,GAAG;AACN,SAAK5B,OAAL,GAAe,KAAf;AACA,SAAKC,cAAL,GAAsB,CAAC,CAAvB;AACD;;AAED4B,EAAAA,KAAK,GAAG;AACN,SAAKP,OAAL,CAAa,CAAb;AACD;;AAEDQ,EAAAA,eAAe,CAACb,SAAD,EAAYc,aAAZ,EAA2B;AACxC,UAAMf,eAAe,GAAGvB,gBAAgB,EAAxC;AAEA,SAAKM,UAAL,CAAgBc,GAAhB,CAAoBG,eAApB,EAAqC;AACnCC,MAAAA,SADmC;AAEnCN,MAAAA,OAAO,EAAEoB;AAF0B,KAArC;AAKAd,IAAAA,SAAS,CAACK,OAAV,CAAkB,KAAKH,OAAL,CAAaY,aAAb,CAAlB;AAEA,WAAOf,eAAP;AACD;;AAEDE,EAAAA,eAAe,CAACR,MAAD,EAAS;AACtB,SAAKX,UAAL,CAAgBgB,MAAhB,CAAuBL,MAAvB;AACD;;AAEDsB,EAAAA,MAAM,CAACC,UAAD,EAAa;AACjB,QAAI,KAAKjC,OAAT,EAAkB;AAChB,UAAI,KAAKC,cAAL,KAAwB,CAAC,CAA7B,EAAgC;AAC9B,aAAKA,cAAL,GAAsBgC,UAAtB;AACD;;AACD,WAAKX,OAAL,CAAa,KAAK1B,IAAL,IAAaqC,UAAU,GAAG,KAAKhC,cAA/B,CAAb;AACA,WAAKA,cAAL,GAAsBgC,UAAtB;AACD;AACF;;AAEDrB,EAAAA,eAAe,CAACD,OAAD,EAAUf,IAAV,EAAgB;AAC7B,UAAMsC,UAAU,GAAGtC,IAAI,GAAGe,OAAO,CAACP,KAAlC;AACA,UAAM+B,aAAa,GAAGxB,OAAO,CAACN,QAAR,GAAmBM,OAAO,CAACF,MAAjD;;AAEA,QAAIyB,UAAU,IAAIC,aAAlB,EAAiC;AAC/BxB,MAAAA,OAAO,CAACf,IAAR,GAAee,OAAO,CAACN,QAAR,GAAmBM,OAAO,CAACH,IAA1C;AACD,KAFD,MAEO;AACLG,MAAAA,OAAO,CAACf,IAAR,GAAe2B,IAAI,CAACC,GAAL,CAAS,CAAT,EAAYU,UAAZ,IAA0BvB,OAAO,CAACN,QAAjD;AACAM,MAAAA,OAAO,CAACf,IAAR,IAAgBe,OAAO,CAACH,IAAxB;AACD;AACF;;AAnHmB","sourcesContent":["let channelHandles = 0;\nlet animationHandles = 0;\n\nexport class Timeline {\n  constructor() {\n    this.time = 0;\n    this.channels = new Map();\n    this.animations = new Map();\n    this.playing = false;\n    this.lastEngineTime = -1;\n  }\n\n  addChannel(props) {\n    const {delay = 0, duration = Number.POSITIVE_INFINITY, rate = 1, repeat = 1} = props;\n\n    const handle = channelHandles++;\n    const channel = {\n      time: 0,\n      delay,\n      duration,\n      rate,\n      repeat\n    };\n    this._setChannelTime(channel, this.time);\n    this.channels.set(handle, channel);\n\n    return handle;\n  }\n\n  removeChannel(handle) {\n    this.channels.delete(handle);\n\n    for (const [animationHandle, animation] of this.animations) {\n      if (animation.channel === handle) {\n        this.detachAnimation(animationHandle);\n      }\n    }\n  }\n\n  getTime(handle) {\n    if (handle === undefined) {\n      return this.time;\n    }\n\n    const channel = this.channels.get(handle);\n\n    if (channel === undefined) {\n      return -1;\n    }\n\n    return channel.time;\n  }\n\n  setTime(time) {\n    this.time = Math.max(0, time);\n\n    const channels = this.channels.values();\n    for (const channel of channels) {\n      this._setChannelTime(channel, this.time);\n    }\n\n    const animations = this.animations.values();\n    for (const animationData of animations) {\n      const {animation, channel} = animationData;\n      animation.setTime(this.getTime(channel));\n    }\n  }\n\n  play() {\n    this.playing = true;\n  }\n\n  pause() {\n    this.playing = false;\n    this.lastEngineTime = -1;\n  }\n\n  reset() {\n    this.setTime(0);\n  }\n\n  attachAnimation(animation, channelHandle) {\n    const animationHandle = animationHandles++;\n\n    this.animations.set(animationHandle, {\n      animation,\n      channel: channelHandle\n    });\n\n    animation.setTime(this.getTime(channelHandle));\n\n    return animationHandle;\n  }\n\n  detachAnimation(handle) {\n    this.animations.delete(handle);\n  }\n\n  update(engineTime) {\n    if (this.playing) {\n      if (this.lastEngineTime === -1) {\n        this.lastEngineTime = engineTime;\n      }\n      this.setTime(this.time + (engineTime - this.lastEngineTime));\n      this.lastEngineTime = engineTime;\n    }\n  }\n\n  _setChannelTime(channel, time) {\n    const offsetTime = time - channel.delay;\n    const totalDuration = channel.duration * channel.repeat;\n    // Note(Tarek): Don't loop on final repeat.\n    if (offsetTime >= totalDuration) {\n      channel.time = channel.duration * channel.rate;\n    } else {\n      channel.time = Math.max(0, offsetTime) % channel.duration;\n      channel.time *= channel.rate;\n    }\n  }\n}\n"],"file":"timeline.js"}